<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FlashDrop Pro - ä¸´æ—¶ã€å®‰å…¨ã€é˜…åå³æ¯</title>
    <meta name="referrer" content="no-referrer-when-downgrade" />
    
    <script>(function(s){s.dataset.zone='10380251',s.src='https://gizokraijaw.net/vignette.min.js'})([document.documentElement, document.body].filter(Boolean).pop().appendChild(document.createElement('script')))</script>
    <script src="https://pl28342028.effectivegatecpm.com/a2/19/f7/a219f7c4a8d2e3bbeea9d014e51bb043.js"></script>
    <script>(function(s){s.dataset.zone='10380245',s.src='https://nap5k.com/tag.min.js'})([document.documentElement, document.body].filter(Boolean).pop().appendChild(document.createElement('script')))</script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    
    <style>
        :root { --primary: #6366f1; --bg: #030712; --card: rgba(30, 41, 59, 0.85); --text: #f8fafc; --text-muted: #94a3b8; --border: #4f46e5; --nav-bg: rgba(15, 23, 42, 0.98); --danger: #ef4444; --success: #10b981; }
        * { box-sizing: border-box; outline: none; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); color: var(--text); margin: 0; min-height: 100vh; display: flex; flex-direction: column; }
        
        /* å‹ç¼©å®¹å™¨é—´è· */
        .app-container { display: flex; flex-direction: column; min-height: 100vh; width: 100%; padding-top: 80px; transition: opacity 0.5s; }
        
        /* å¯¼èˆª */
        .navbar { position: fixed; top: 0; left: 0; right: 0; height: 70px; background: var(--nav-bg); border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; z-index: 1000; padding: 0 20px; backdrop-filter: blur(20px); }
        .logo { font-size: 20px; font-weight: 900; color: white; }
        .logo span { color: var(--primary); }

        /* å¼ºåˆ¶æ˜¾ç¤º Hero ç‰¹æ€§åŒº */
        .hero-section { text-align: center; padding: 15px 10px; max-width: 600px; margin: 0 auto; width: 100%; }
        .safety-promise { background: rgba(16, 185, 129, 0.1); border: 1px solid var(--success); border-radius: 10px; padding: 6px 12px; display: inline-flex; gap: 8px; font-size: 10px; font-weight: 700; color: var(--success); margin-bottom: 10px; }
        
        .hero-title { font-size: 22px; font-weight: 900; margin: 0 0 5px 0; line-height: 1.2; }
        .hero-title span { color: var(--primary); }
        .hero-subtitle { font-size: 13px; color: var(--text-muted); margin-bottom: 15px; line-height: 1.4; padding: 0 15px; }

        /* ä¸‰å¤§ä¼˜åŠ¿å›å½’ */
        .advantage-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 15px; padding: 0 10px; }
        .adv-card { background: rgba(99, 102, 241, 0.1); border: 1px solid var(--border); border-radius: 12px; padding: 10px 5px; text-align: center; }
        .adv-card .tit { font-size: 11px; font-weight: 800; color: white; display: block; }
        .adv-card .desc { font-size: 9px; color: var(--text-muted); margin-top: 3px; display: block; }

        /* å¹¿å‘Šå¸ƒå±€ä¼˜åŒ– */
        .main-wrapper { display: flex; width: 100%; margin: 0 auto; justify-content: center; align-items: flex-start; gap: 10px; padding: 0 10px; flex: 1; }
        .ad-side { width: 140px; min-width: 140px; display: flex; flex-direction: column; gap: 15px; }
        @media (max-width: 900px) { .ad-side { display: none !important; } }

        /* æ ¸å¿ƒå†…å®¹åŒº */
        .content-area { flex: 1; min-width: 300px; max-width: 550px; display: flex; flex-direction: column; align-items: center; }
        .card { background: var(--card); padding: 15px; border-radius: 25px; border: 1px solid rgba(255,255,255,0.1); width: 100%; box-shadow: 0 20px 40px rgba(0,0,0,0.5); }
        
        /* é€‰é¡¹å¡ */
        .tab-group { display: flex; background: rgba(51, 65, 85, 0.7); padding: 4px; border-radius: 15px; margin-bottom: 12px; }
        .tab { flex: 1; padding: 10px; cursor: pointer; border-radius: 11px; font-size: 13px; text-align: center; color: var(--text-muted); font-weight: 800; }
        .tab.active { background: var(--primary); color: white; }
        .panel { display: none; }
        .panel.active { display: block; }

        /* åŠŸèƒ½åŒºä¿®æ­£ */
        .file-zone { border: 2px dashed var(--border); border-radius: 18px; padding: 20px; background: rgba(15, 23, 42, 0.5); cursor: pointer; text-align: center; margin-bottom: 12px; width: 100%; transition: 0.3s; }
        #stagedList { display: none; background: rgba(15, 23, 42, 0.6); border: 1px solid var(--border); border-radius: 10px; padding: 8px; margin-bottom: 12px; max-height: 100px; overflow-y: auto; width: 100%; }
        .staged-item { display: flex; justify-content: space-between; align-items: center; font-size: 11px; padding: 5px 8px; background: rgba(255,255,255,0.05); border-radius: 6px; margin-bottom: 4px; }
        .text-zone { border: 1px solid var(--border); border-radius: 18px; padding: 10px; background: rgba(15, 23, 42, 0.5); height: 100px; margin-bottom: 12px; }
        textarea { background: transparent; border: none; color: white; resize: none; width: 100%; height: 100%; font-size: 13px; }
        
        button.action-btn { background: var(--primary); color: white; border: none; padding: 14px; border-radius: 14px; font-size: 13px; cursor: pointer; width: 100%; font-weight: 800; text-transform: uppercase; }
        
        #senderCodeArea { margin-top: 15px; border: 2px solid var(--success); border-radius: 20px; padding: 15px; display: none; text-align: center; background: rgba(16, 185, 129, 0.05); }
        .code-display { font-size: 40px; letter-spacing: 4px; font-weight: 900; color: #a5b4fc; margin: 8px 0; }
        #qrcode { background: white; padding: 8px; border-radius: 10px; display: inline-block; }

        /* é¡µè„šå‹ç¼© */
        .legal-footer { padding: 20px; background: #030712; color: var(--text-muted); text-align: center; font-size: 11px; border-top: 1px solid var(--border); margin-top: 20px; }
        .stars-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; background: radial-gradient(ellipse at bottom, #1B2735 0%, #090A0F 100%); }
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.9); z-index: 5000; display: none; justify-content: center; align-items: center; flex-direction: column; }
    </style>
</head>
<body>

<div class="app-container" id="app">
    <div class="stars-container" id="stars"></div>
    <nav class="navbar">
        <div class="logo">âš¡ Flash<span>Drop</span> Pro</div>
        <div id="currentLangTag" style="font-size:10px; color:var(--primary); font-weight:900; border:1.5px solid var(--primary); padding:2px 6px; border-radius:6px;">EN</div>
    </nav>

    <header class="hero-section">
        <div class="safety-promise">
            <span id="prom-1">âœ“ No Signup</span><span id="prom-2">âœ“ No Storage</span><span id="prom-3">âœ“ No Logs</span>
        </div>
        <h1 class="hero-title" id="h-title">Temporary & <span>Vanishing</span></h1>
        <p class="hero-subtitle" id="h-sub">Direct P2P transfer. No servers. Data is wiped when session ends.</p>
        
        <div class="advantage-grid">
            <div class="adv-card">
                <div class="tit" id="adv-1-t">10m Auto-Kill</div>
                <div class="desc" id="adv-1-d">Expires automatically</div>
            </div>
            <div class="adv-card">
                <div class="tit" id="adv-2-t">Visit Limit</div>
                <div class="desc" id="adv-2-d">1 / 3 / 5 / Max</div>
            </div>
            <div class="adv-card">
                <div class="tit" id="adv-3-t">Instant Stop</div>
                <div class="desc" id="adv-3-d">Terminate anytime</div>
            </div>
        </div>
    </header>

    <div class="ad-space ad-top">
        <script>atOptions={'key':'fabada29768bc51cc0a6a76937a99ba9','format':'iframe','height':90,'width':728,'params':{}};</script>
        <script src="https://www.highperformanceformat.com/fabada29768bc51cc0a6a76937a99ba9/invoke.js"></script>
    </div>

    <div class="main-wrapper">
        <aside class="ad-side">
            <script>atOptions={'key':'bd9abdb5a8bd5a53648a9afb54343727','format':'iframe','height':600,'width':160,'params':{}};</script>
            <script src="https://www.highperformanceformat.com/bd9abdb5a8bd5a53648a9afb54343727/invoke.js"></script>
        </aside>

        <main class="content-area">
            <div class="card">
                <div class="tab-group">
                    <div id="tab-send" class="tab active" onclick="switchTab('send', event)">SEND</div>
                    <div id="tab-receive" class="tab" onclick="switchTab('receive', event)">RECEIVE</div>
                </div>

                <div id="panel-send" class="panel active">
                    <label class="file-zone" for="fileInput">
                        <div style="font-size: 32px;">ğŸ“‚</div>
                        <div id="label-files" style="font-size:12px; margin-top:5px; font-weight:900;">Drop / Click</div>
                    </label>
                    <input type="file" id="fileInput" multiple style="display:none;" onchange="handleFiles(this.files)">
                    <div id="stagedList"></div>
                    <div class="text-zone"><textarea id="quickText" placeholder="Paste text here..."></textarea></div>
                    <div style="margin-bottom:12px; text-align:center;">
                        <span id="label-limit" style="font-size:11px; color:var(--text-muted);">Limit: </span>
                        <select id="downloadLimit" style="background:#0f172a; color:#fff; border:1.5px solid var(--border); padding:4px; border-radius:8px; font-size:11px;">
                            <option value="1">1 Time</option><option value="3">3 Times</option><option value="5">5 Times</option><option value="999">Unlimited</option>
                        </select>
                    </div>
                    <button class="action-btn" id="btn-share-main" onclick="triggerAd('send')">START SHARING</button>

                    <div id="senderCodeArea">
                        <div id="qrcode"></div>
                        <div class="code-display" id="myCode">000000</div>
                        <div id="expiryTimer" style="font-size:13px; color:var(--danger); font-weight:900;">Expires: 10:00</div>
                        <button class="action-btn" onclick="resetSender()" style="background:var(--danger); margin-top:10px;">STOP & DESTROY</button>
                    </div>
                </div>

                <div id="panel-receive" class="panel">
                    <input type="number" id="targetCode" placeholder="000000" style="width:100%; padding:12px; font-size:24px; text-align:center; background:#0f172a; border:2.5px solid var(--border); border-radius:12px; color:white; margin-bottom:12px;">
                    <button class="action-btn" id="btn-receive-main" onclick="triggerAd('receive')">DOWNLOAD</button>
                    <div id="receive-pg-container" class="pg-container"><div id="receive-pg-bar" class="pg-bar"></div></div>
                    <div id="receivedText-container" style="display:none; margin-top:10px; padding:10px; background:rgba(255,255,255,0.05); border-radius:12px;">
                        <div id="receivedText" style="word-break:break-all; font-size:12px; margin-bottom:8px;"></div>
                        <button class="action-btn" onclick="copyText()">COPY</button>
                    </div>
                    <div id="mobileDownloadArea" style="display:none; margin-top:10px;"><button class="action-btn" id="btn-save-file" style="background:var(--success);">SAVE FILE</button></div>
                </div>
            </div>

            <div class="ad-space ad-bottom">
                <script>atOptions={'key':'fabada29768bc51cc0a6a76937a99ba9','format':'iframe','height':90,'width':728,'params':{}};</script>
                <script src="https://www.highperformanceformat.com/fabada29768bc51cc0a6a76937a99ba9/invoke.js"></script>
            </div>
            <div style="width:100%; margin-top:15px; font-size:10px; color:var(--text-muted); text-align:center;" id="history-title">HISTORY (LOCAL)</div>
            <div style="width:100%;" id="history-list"></div>
        </main>

        <aside class="ad-side">
            <script>atOptions={'key':'bd9abdb5a8bd5a53648a9afb54343727','format':'iframe','height':600,'width':160,'params':{}};</script>
            <script src="https://www.highperformanceformat.com/bd9abdb5a8bd5a53648a9afb54343727/invoke.js"></script>
        </aside>
    </div>

    <footer class="legal-footer">
        <p>Tel: +1 929-266-4485 | Email: flashdroppro@gmail.com</p>
        <p style="margin-top:5px; opacity:0.5;">Efficiency First. Direct P2P. No Logs.</p>
    </footer>
</div>

<div class="modal-overlay" id="adModal">
    <div id="ad-wait-title" style="color:white; margin-bottom:10px; font-weight:bold; font-size:14px;">Security Checking...</div>
    <div style="width: 250px; height: 5px; background: rgba(255,255,255,0.1); border-radius: 4px; overflow: hidden; margin-bottom: 15px;">
        <div id="ad-pg-bar" style="height: 100%; width: 0%; background: var(--primary);"></div>
    </div>
    <div style="width:300px; height:250px; background:white; border-radius:15px; overflow:hidden;">
        <script>atOptions={'key':'05aeca9dfc228cb50e7ad828813cd55b','format':'iframe','height':250,'width':300,'params':{}};</script>
        <script src="https://www.highperformanceformat.com/05aeca9dfc228cb50e7ad828813cd55b/invoke.js"></script>
    </div>
</div>

<script>
    const I18N = {
        en: { send: "SEND", receive: "RECEIVE", drop: "Drop / Click", start: "START SHARING", dl: "DOWNLOAD", prom1: "âœ“ No Signup", prom2: "âœ“ No Storage", prom3: "âœ“ No Logs", title: "Temporary & <span>Vanishing</span>", sub: "Direct P2P transfer. No servers. Data is wiped when session ends.", adv1t: "10m Auto-Kill", adv1d: "Expires automatically", adv2t: "Visit Limit", adv2d: "1 / 3 / 5 / Max", adv3t: "Instant Stop", adv3d: "Terminate anytime", limit: "Limit: ", exp: "Expires: ", save: "SAVE FILE", copy: "COPY" },
        zh: { send: "å‘é€", receive: "æ¥æ”¶", drop: "æ‹–æ‹½ / ç‚¹å‡»", start: "å¼€å§‹åˆ†äº«", dl: "ç«‹å³ä¸‹è½½", prom1: "âœ“ æ— éœ€æ³¨å†Œ", prom2: "âœ“ ä¸åšå­˜å‚¨", prom3: "âœ“ é›¶æ—¥å¿—", title: "ç¬æ—¶ã€<span>é˜…åå³æ¯</span>çš„ä¼ è¾“", sub: "ç›´è¿ P2P ä¼ è¾“ã€‚å®Œæˆæˆ–å…³é—­é¡µé¢åï¼Œæ•°æ®å³åˆ»ç‰©ç†æŠ¹é™¤ã€‚", adv1t: "10åˆ†é’Ÿè‡ªåŠ¨é”€æ¯", adv1d: "ä¼šè¯åˆ°æœŸè‡ªåŠ¨å¤±æ•ˆ", adv2t: "è®¿é—®æ¬¡æ•°å¯é€‰", adv2d: "æ”¯æŒ 1/3/5/æ— é™æ¬¡", adv3t: "éšæ—¶æ‰‹åŠ¨ç»ˆæ­¢", adv3d: "ä¸€é”®åˆ‡æ–­æ‰€æœ‰ä¼ è¾“", limit: "é™åˆ¶: ", exp: "åˆ°æœŸ: ", save: "ä¿å­˜æ–‡ä»¶", copy: "å¤åˆ¶æ–‡å­—" },
        ja: { send: "é€ä¿¡", receive: "å—ä¿¡", drop: "ã‚¯ãƒªãƒƒã‚¯/ãƒ‰ãƒ­ãƒƒãƒ—", start: "å…±æœ‰é–‹å§‹", dl: "ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰", prom1: "âœ“ ç™»éŒ²ä¸è¦", prom2: "âœ“ ä¿å­˜ãªã—", prom3: "âœ“ ãƒ­ã‚°ãªã—", title: "ä¸€æ™‚çš„ãª<span>æ¶ˆãˆã‚‹</span>è»¢é€", sub: "ç›´æ¥P2Pè»¢é€ã€‚çµ‚äº†ã¾ãŸã¯é–‰ã˜ã‚‹ã¨ãƒ‡ãƒ¼ã‚¿ã¯å®Œå…¨ã«æ¶ˆå»ã•ã‚Œã¾ã™ã€‚", adv1t: "10åˆ†ã§è‡ªå‹•æ¶ˆå»", adv2t: "å›æ•°åˆ¶é™", adv3t: "å³æ™‚åœæ­¢", limit: "åˆ¶é™: ", exp: "æœŸé™: " },
        ko: { send: "ë³´ë‚´ê¸°", receive: "ë°›ê¸°", drop: "í´ë¦­/ë“œë¡­", start: "ê³µìœ  ì‹œì‘", dl: "ë‹¤ìš´ë¡œë“œ", prom1: "âœ“ ê°€ì… ì—†ìŒ", prom2: "âœ“ ì €ì¥ ì—†ìŒ", prom3: "âœ“ ë¡œê·¸ ì—†ìŒ", title: "ì„ì‹œ ë° <span>ì‚¬ë¼ì§€ëŠ”</span> ì „ì†¡", sub: "ì§ì ‘ P2P ì „ì†¡. ì™„ë£Œë˜ê±°ë‚˜ ë‹«íˆë©´ ë°ì´í„°ê°€ ì™„ì „íˆ ì‚­ì œë©ë‹ˆë‹¤.", adv1t: "10ë¶„ ìë™ íŒŒê¸°", adv2t: "ë°©ë¬¸ ì œí•œ", adv3t: "ì¦‰ì‹œ ì¤‘ë‹¨", limit: "ì œí•œ: ", exp: "ë§Œë£Œ: " },
        es: { send: "ENVIAR", receive: "RECIBIR", drop: "Soltar / Click", start: "INICIAR", dl: "DESCARGAR", prom1: "âœ“ Sin registro", prom2: "âœ“ Sin almacenamiento", prom3: "âœ“ Sin registros", title: "Transferencia <span>EfÃ­mera</span>", sub: "P2P directo. Una vez cerrado, los datos se borran fÃ­sicamente.", adv1t: "10m Auto-destrucciÃ³n", adv2t: "LÃ­mite visitas", adv3t: "Corte instantÃ¡neo", limit: "LÃ­mite: ", exp: "Expira: " },
        hi: { send: "à¤­à¥‡à¤œà¥‡à¤‚", receive: "à¤ªà¥à¤°à¤¾à¤ªà¥à¤¤ à¤•à¤°à¥‡à¤‚", drop: "à¤¡à¥à¤°à¥‰à¤ª / à¤•à¥à¤²à¤¿à¤•", start: "à¤¸à¤¾à¤à¤¾ à¤•à¤°à¥‡à¤‚", dl: "à¤¡à¤¾à¤‰à¤¨à¤²à¥‹à¤¡", prom1: "âœ“ à¤•à¥‹à¤ˆ à¤ªà¤‚à¤œà¥€à¤•à¤°à¤£ à¤¨à¤¹à¥€à¤‚", prom2: "âœ“ à¤•à¥‹à¤ˆ à¤¸à¥à¤Ÿà¥‹à¤°à¥‡à¤œ à¤¨à¤¹à¥€à¤‚", prom3: "âœ“ à¤•à¥‹à¤ˆ à¤²à¥‰à¤— à¤¨à¤¹à¥€à¤‚", title: "à¤…à¤¸à¥à¤¥à¤¾à¤¯à¥€ à¤”à¤° <span>à¤—à¤¾à¤¯à¤¬</span> à¤¹à¥‹à¤¨à¥‡ à¤µà¤¾à¤²à¤¾ à¤Ÿà¥à¤°à¤¾à¤‚à¤¸à¤«à¤°", sub: "à¤¸à¥€à¤§à¤¾ P2P à¤Ÿà¥à¤°à¤¾à¤‚à¤¸à¤«à¤°à¥¤ à¤¬à¤‚à¤¦ à¤¹à¥‹à¤¨à¥‡ à¤ªà¤° à¤¡à¥‡à¤Ÿà¤¾ à¤¨à¤·à¥à¤Ÿ à¤¹à¥‹ à¤œà¤¾à¤¤à¤¾ à¤¹à¥ˆà¥¤", adv1t: "10 à¤®à¤¿à¤¨à¤Ÿ à¤®à¥‡à¤‚ à¤¨à¤·à¥à¤Ÿ", adv2t: "à¤µà¤¿à¤œà¤¿à¤Ÿ à¤¸à¥€à¤®à¤¾", adv3t: "à¤¤à¥à¤°à¤‚à¤¤ à¤°à¥‹à¤•à¥‡à¤‚", limit: "à¤¸à¥€à¤®à¤¾: ", exp: "à¤¸à¤®à¤¾à¤ªà¥à¤¤à¤¿: " }
    };

    let currLang = "en", peer = null, stagedFiles = [], expiryTimerIdx = null, activeConn = null, downloads = 0;
    const PREFIX = "fd-pro-", CHUNK_SIZE = 262144;

    function applyI18N() {
        const userLang = navigator.language.split('-')[0];
        currLang = I18N[userLang] ? userLang : "en";
        const d = I18N[currLang];
        document.getElementById('currentLangTag').innerText = currLang.toUpperCase();
        document.getElementById('tab-send').innerText = d.send; document.getElementById('tab-receive').innerText = d.receive;
        document.getElementById('label-files').innerText = d.drop; document.getElementById('btn-share-main').innerText = d.start;
        document.getElementById('btn-receive-main').innerText = d.dl; document.getElementById('label-limit').innerText = d.limit;
        document.getElementById('prom-1').innerText = d.prom1; document.getElementById('prom-2').innerText = d.prom2; document.getElementById('prom-3').innerText = d.prom3;
        document.getElementById('h-title').innerHTML = d.title; document.getElementById('h-sub').innerText = d.sub;
        document.getElementById('adv1t').innerText = d.adv1t; document.getElementById('adv1d').innerText = d.adv1d;
        document.getElementById('adv2t').innerText = d.adv2t; document.getElementById('adv2d').innerText = d.adv2d;
        document.getElementById('adv3t').innerText = d.adv3t; document.getElementById('adv3d').innerText = d.adv3d;
    }

    function handleFiles(files) { stagedFiles = stagedFiles.concat(Array.from(files)); renderStagedList(); }
    function renderStagedList() {
        const list = document.getElementById('stagedList');
        if (stagedFiles.length === 0) { list.style.display = 'none'; return; }
        list.style.display = 'block';
        list.innerHTML = stagedFiles.map((f, i) => `<div class="staged-item"><span>ğŸ“„ ${f.name.length > 20 ? f.name.substring(0,17)+'...' : f.name}</span><span style="color:var(--danger); cursor:pointer;" onclick="removeFile(${i})">âœ•</span></div>`).join('');
    }
    function removeFile(index) { stagedFiles.splice(index, 1); renderStagedList(); }

    function triggerAd(mode) {
        const modal = document.getElementById('adModal');
        const adPg = document.getElementById('ad-pg-bar');
        modal.style.display = 'flex'; adPg.style.width = '0%';
        let elapsed = 0; const totalMs = 3000;
        const itv = setInterval(() => { 
            elapsed += 100; adPg.style.width = (elapsed/totalMs)*100 + '%';
            if(elapsed >= totalMs) { clearInterval(itv); modal.style.display = 'none'; mode === 'send' ? initSender() : startReceiving(); } 
        }, 100);
    }

    async function initSender() {
        if(peer) peer.destroy(); downloads = 0;
        const code = Math.floor(100000 + Math.random() * 900000);
        peer = new Peer(PREFIX + code);
        peer.on('open', () => {
            document.getElementById('senderCodeArea').style.display = 'block';
            document.getElementById('myCode').innerText = code;
            document.getElementById('qrcode').innerHTML = "";
            new QRCode(document.getElementById('qrcode'), { text: window.location.origin + window.location.pathname + "?c=" + code, width: 120, height: 120 });
            startExpiryTimer();
        });
        peer.on('connection', c => {
            c.on('data', d => { if(d.type === 'confirm') { downloads++; if(downloads >= parseInt(document.getElementById('downloadLimit').value)) resetSender(); } });
            c.on('open', async () => {
                const text = document.getElementById('quickText').value;
                if(text) c.send({ type: 'text', data: text });
                if(stagedFiles.length > 0) {
                    let fb, fn;
                    if(stagedFiles.length === 1) { fb = stagedFiles[0]; fn = stagedFiles[0].name; }
                    else { const zip = new JSZip(); stagedFiles.forEach(f => zip.file(f.name, f)); fb = await zip.generateAsync({type:"blob"}); fn = "Bundle.zip"; }
                    c.send({ type: 'meta', name: fn, size: fb.size });
                    for(let i=0; i<fb.size; i+=CHUNK_SIZE) { c.send({ type: 'chunk', index: i/CHUNK_SIZE, data: await fb.slice(i, i+CHUNK_SIZE).arrayBuffer() }); }
                    c.send({ type: 'done' });
                }
            });
        });
    }

    function startReceiving() {
        const code = document.getElementById('targetCode').value;
        const rPeer = new Peer();
        const pgBar = document.getElementById('receive-pg-bar');
        document.getElementById('receive-pg-container').style.display = 'block';
        rPeer.on('open', () => {
            const c = rPeer.connect(PREFIX + code); activeConn = c;
            let meta = null, chunks = [], totalRecv = 0;
            c.on('data', d => {
                if(d.type === 'text') { document.getElementById('receivedText').innerText = d.data; document.getElementById('receivedText-container').style.display = 'block'; }
                else if(d.type === 'meta') { meta = d; document.getElementById('mobileDownloadArea').style.display = 'block'; }
                else if(d.type === 'chunk') { chunks[d.index] = d.data; totalRecv += d.data.byteLength; if(meta) pgBar.style.width = (totalRecv/meta.size)*100 + '%'; }
                else if(d.type === 'done') {
                    const b = new Blob(chunks); const u = URL.createObjectURL(b);
                    const btn = document.getElementById('btn-save-file');
                    btn.onclick = () => { 
                        const a = document.createElement('a'); a.href = u; a.download = meta.name; a.click(); 
                        c.send({type:'confirm'}); setTimeout(() => location.reload(), 1000);
                    };
                }
            });
        });
    }

    function startExpiryTimer() { 
        let sec = 600; if(expiryTimerIdx) clearInterval(expiryTimerIdx); 
        expiryTimerIdx = setInterval(() => { 
            sec--; document.getElementById('expiryTimer').innerText = `${I18N[currLang].exp}${Math.floor(sec/60)}:${(sec%60).toString().padStart(2,'0')}`; 
            if(sec <= 0) resetSender(); 
        }, 1000); 
    }
    
    function resetSender() { if(peer) peer.destroy(); location.reload(); }
    function switchTab(m, e) { document.querySelectorAll('.tab').forEach(t => t.classList.remove('active')); document.querySelectorAll('.panel').forEach(p => p.classList.remove('active')); e.target.classList.add('active'); document.getElementById(`panel-${m}`).classList.add('active'); }
    function copyText() { navigator.clipboard.writeText(document.getElementById('receivedText').innerText); alert("Copied!"); if(activeConn) activeConn.send({type:'confirm'}); }
    
    window.onload = () => {
        applyI18N();
        const urlParams = new URLSearchParams(window.location.search);
        if(urlParams.get('c')) { document.getElementById('targetCode').value = urlParams.get('c'); switchTab('receive', {target: document.getElementById('tab-receive')}); }
    };
</script>
</body>
</html>
