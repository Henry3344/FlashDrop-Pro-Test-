<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>FlashDrop Pro ‚Äî AI-Powered Secure Workspace</title>
<link rel="icon" href="./image/favicon.png" type="image/png">
<meta name="description" content="Secure P2P file transfer with optional AES-256 encryption. No servers, no logs, no limits.">
<meta name="keywords" content="P2P transfer, encrypted file sharing, WebRTC, privacy first, file drop, OCR, image to text">
<meta name="referrer" content="no-referrer">
<meta property="og:title" content="FlashDrop Pro ‚Äî Secure P2P Workspace">
<meta property="og:description" content="Browser-based P2P file sharing. Files never touch our servers.">
    
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    
    <style>
        :root { --primary: #6366f1; --bg: #030712; --card: rgba(30, 41, 59, 0.85); --text: #f8fafc; --text-muted: #94a3b8; --border: #4f46e5; --nav-bg: rgba(15, 23, 42, 0.98); --danger: #ef4444; --success: #10b981; --ai: #8b5cf6; }
        * { box-sizing: border-box; outline: none; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: var(--bg); color: var(--text); margin: 0; min-height: 100vh; overflow-x: hidden; display: flex; flex-direction: column; }
        
        .app-container { display: flex; flex-direction: column; min-height: 100vh; width: 100%; padding-top: 130px; transition: opacity 0.5s; }
        body.is-blocked .app-container { opacity: 0.15; pointer-events: none; }

        /* --- ÂÆâÂÖ®Ë≠¶Âëä & ÂπøÂëäÊã¶Êà™ --- */
        #safety-notice-view { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 999999; display: none; justify-content: center; align-items: center; padding: 20px; background: rgba(3, 7, 18, 0.9); backdrop-filter: blur(8px); }
        .safety-card { background: #111827; padding: 40px 30px; border-radius: 32px; border: 1px solid var(--border); text-align: center; max-width: 420px; width: 100%; box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5); }
        .safety-card .icon { font-size: 48px; margin-bottom: 20px; }
        .safety-card h3 { color: var(--text); margin: 0 0 15px 0; font-size: 22px; font-weight: 900; letter-spacing: 1px; }
        .safety-card p.safety-text { font-size: 14px; color: var(--text-muted); line-height: 1.8; margin-bottom: 30px; display: block !important; visibility: visible !important; }

        /* --- ËÉåÊôØÊòüÊòüÂä®Áîª --- */
        .stars-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; background: radial-gradient(ellipse at bottom, #1B2735 0%, #090A0F 100%); pointer-events: none; }
        .star { position: absolute; background: white; border-radius: 50%; opacity: 0.5; animation: moveStars linear infinite; }
        @keyframes moveStars { from { transform: translateY(0); } to { transform: translateY(-1000px); } }
        
        /* --- ÂØºËà™Ê†è --- */
        .navbar { position: fixed; top: 0; left: 0; right: 0; height: 120px; background: var(--nav-bg); border-bottom: 1px solid var(--border); display: flex; flex-direction: column; align-items: center; justify-content: flex-start; z-index: 5000; backdrop-filter: blur(25px); padding: 10px 15px; box-shadow: 0 4px 30px rgba(0,0,0,0.5); }
        .logo-wrap { display: flex; align-items: center; gap: 12px; width: 100%; justify-content: center; margin-bottom: 8px; }
        .logo { font-size: 24px; font-weight: 900; color: white; letter-spacing: 2px; display: flex; align-items: center; }
        .logo img { height: 40px; width: auto; vertical-align: middle; }
        
        .status-container { display: flex; flex-direction: column; align-items: center; margin-right: 12px; }
        .status-dot { width: 10px; height: 10px; border-radius: 50%; background: #666; transition: 0.3s; box-shadow: 0 0 10px rgba(0,0,0,0.5); margin-bottom: 2px; }
        .status-dot.online { background: var(--success); box-shadow: 0 0 15px var(--success); }
        .status-dot.offline { background: var(--danger); box-shadow: 0 0 15px var(--danger); }
        .status-text { font-size: 8px; font-weight: 800; text-transform: uppercase; letter-spacing: 0.5px; transition: 0.3s; }
        .status-text.online { color: var(--success); }
        .status-text.offline { color: var(--danger); }

        /* --- [NEW] ÊêúÁ¥¢Ê°ÜÊ†∑Âºè (‰Ω†ÁöÑÊ†∏ÂøÉÈúÄÊ±Ç) --- */
        .search-wrapper { position: relative; width: 100%; max-width: 500px; height: 44px; background: rgba(30, 41, 59, 0.6); border: 1px solid rgba(255, 255, 255, 0.15); border-radius: 22px; display: flex; align-items: center; padding: 0 6px 0 15px; transition: 0.3s; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        .search-wrapper:hover, .search-wrapper.active { border-color: var(--primary); background: rgba(30, 41, 59, 0.9); box-shadow: 0 0 15px rgba(99, 102, 241, 0.15); }

        .search-scope { font-size: 12px; font-weight: 700; color: var(--text-muted); cursor: pointer; padding-right: 10px; border-right: 1px solid rgba(255,255,255,0.1); white-space: nowrap; display: flex; align-items: center; gap: 4px; transition: color 0.2s; }
        .search-scope:hover { color: white; }
        .search-scope::after { content: '‚ñº'; font-size: 8px; margin-left: 2px; opacity: 0.7; }

        .search-ticker { flex: 1; margin: 0 12px; overflow: hidden; height: 100%; display: flex; align-items: center; cursor: pointer; position: relative; }
        /* Ê∏êÂèòÊ®°Á≥äÁâπÊïàÔºöÂè≥‰æßÊ∏êÈöê */
        .ticker-text { 
            white-space: nowrap; color: #cbd5e1; font-size: 13px; font-weight: 500; 
            width: 100%; display: block;
            mask-image: linear-gradient(to right, black 85%, transparent 100%);
            -webkit-mask-image: linear-gradient(to right, black 85%, transparent 100%);
            animation: slideUp 0.5s ease-out;
        }
        @keyframes slideUp { from { transform: translateY(10px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        .search-divider { width: 1px; height: 20px; background: rgba(255,255,255,0.2); margin-right: 8px; }
        .search-btn { width: 32px; height: 32px; border-radius: 50%; border: none; background: transparent; color: white; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 16px; transition: 0.2s; }
        .search-btn:hover { background: rgba(255,255,255,0.1); color: var(--primary); transform: scale(1.1); }

        /* ‰∏ãÊãâËèúÂçïÊ†∑Âºè */
        .search-dropdown { 
            position: absolute; top: 52px; left: 0; width: 100%; 
            background: rgba(15, 23, 42, 0.95); backdrop-filter: blur(20px);
            border: 1px solid var(--border); border-radius: 16px; 
            padding: 15px; display: none; flex-direction: column; 
            z-index: 5001; box-shadow: 0 20px 60px rgba(0,0,0,0.6);
            transform-origin: top; animation: dropDown 0.2s ease-out;
        }
        @keyframes dropDown { from { opacity: 0; transform: scaleY(0.9); } to { opacity: 1; transform: scaleY(1); } }
        
        .sd-header { font-size: 10px; color: var(--primary); font-weight: 800; text-transform: uppercase; margin-bottom: 10px; display: flex; align-items: center; gap: 6px; }
        .sd-item { display: flex; align-items: center; gap: 10px; padding: 8px 10px; border-radius: 8px; cursor: pointer; transition: 0.2s; color: #e2e8f0; font-size: 13px; }
        .sd-item:hover { background: rgba(99, 102, 241, 0.15); color: white; }
        .sd-rank { font-weight: 900; font-family: monospace; width: 15px; text-align: center; }
        .rank-1 { color: #ef4444; } .rank-2 { color: #f97316; } .rank-3 { color: #eab308; } .rank-n { color: #94a3b8; }
        
        .sd-divider { height: 1px; background: rgba(255,255,255,0.1); margin: 10px 0; width: 100%; }
        .history-tag { background: rgba(255,255,255,0.05); padding: 4px 8px; border-radius: 4px; font-size: 11px; color: #94a3b8; margin: 2px; display: inline-block; cursor: pointer; transition: 0.2s; }
        .history-tag:hover { background: rgba(255,255,255,0.15); color: white; }

        /* --- Â∏ÉÂ±ÄÂÆπÂô® --- */
        .main-wrapper { display: flex; width: 100%; margin: 0 auto; justify-content: center; align-items: flex-start; gap: 20px; padding: 0 15px; }
        .content-area { flex: 1; min-width: 300px; max-width: 600px; display: flex; flex-direction: column; align-items: center; z-index: 50; }
        
        .ad-side { 
            width: 160px; min-width: 160px; position: sticky; top: 130px; 
            display: flex; flex-direction: column; align-items: center; 
            border-radius: 12px; background: transparent; overflow: hidden; 
            transition: 0.3s; gap: 20px; 
        }
        .ad-space { background: transparent; display: flex; justify-content: center; align-items: center; border-radius: 12px; overflow: hidden; width: 100%; transition: 0.3s; }
        .ad-top { min-height: 0; margin-bottom: 15px; }
        .ad-bottom { min-height: 0; margin-top: 20px; margin-bottom: 25px; }
        @media (max-width: 880px) { .ad-side { display: none !important; } }
        
        /* --- Hero Âå∫ÂüüÊ†∑Âºè --- */
        .hero-bullets { display: flex; gap: 10px; justify-content: center; margin-top: 15px; flex-wrap: wrap; }
        .hero-bullets span { background: rgba(99, 102, 241, 0.15); padding: 6px 12px; border-radius: 20px; font-size: 11px; font-weight: 800; color: #c7d2fe; border: 1px solid rgba(99, 102, 241, 0.3); white-space: nowrap; box-shadow: 0 0 10px rgba(99, 102, 241, 0.1); }
        /* --- ÂÆâÂÖ®ÁâπÊÄßÁΩëÊ†ºÊ†∑Âºè --- */
        .security-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 15px; margin: 30px 0; width: 100%; }
        .sec-card { background: rgba(30, 41, 59, 0.4); border: 1px solid rgba(255, 255, 255, 0.08); border-radius: 20px; padding: 20px; text-align: left; transition: 0.3s; }
        .sec-card:hover { border-color: var(--primary); background: rgba(30, 41, 59, 0.7); }
        .sec-card h3 { color: white; margin: 0 0 10px 0; font-size: 15px; font-weight: 900; display: flex; align-items: center; gap: 8px; letter-spacing: 0.5px; }
        .sec-card p { font-size: 12px; color: var(--text-muted); line-height: 1.6; margin: 0; }
        .sec-card ul { margin: 10px 0 0 0; padding-left: 20px; color: var(--text-muted); font-size: 12px; line-height: 1.6; }
        .fingerprint-demo { background: rgba(0,0,0,0.3); padding: 10px; border-radius: 12px; font-family: monospace; text-align: center; margin-bottom: 10px; font-size: 16px; border: 1px dashed rgba(255,255,255,0.2); }

        /* --- Âç°Áâá‰∏éÈÄâÈ°πÂç°Ê†∑Âºè --- */
        .card { background: var(--card); padding: 25px; border-radius: 30px; backdrop-filter: blur(25px); border: 1px solid rgba(255,255,255,0.1); width: 100%; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.9); }
        .tab-group { display: flex; background: rgba(51, 65, 85, 0.7); padding: 5px; border-radius: 18px; margin-bottom: 25px; }
        .tab { flex: 1; padding: 14px; cursor: pointer; border-radius: 14px; font-size: 14px; text-align: center; color: var(--text-muted); font-weight: 800; transition: 0.3s; }
        .tab.active { background: var(--primary); color: white; box-shadow: 0 4px 20px rgba(99, 102, 241, 0.5); }
        .panel { display: none; width: 100%; }
        .panel.active { display: block; }

        .share-grid { display: grid; grid-template-columns: 1.2fr 1fr; gap: 15px; margin-bottom: 15px; align-items: stretch; }
        @media (max-width: 550px) { .share-grid { grid-template-columns: 1fr; } }
        .column-box { display: flex; flex-direction: column; gap: 10px; min-height: 220px; }
        
        #drop-zone { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 9999; background: rgba(3, 7, 18, 0.95); display: none; justify-content: center; align-items: center; backdrop-filter: blur(10px); }
        .file-zone { position: relative; border: 2.5px dashed var(--border); border-radius: 20px; padding: 25px; background: rgba(15, 23, 42, 0.5); cursor: pointer; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 150px; text-align: center; transition: 0.3s; backdrop-filter: blur(15px); }
        .file-zone.drag-active, #drop-zone.drag-active { background: rgba(99, 102, 241, 0.3); border-color: #fff; transform: scale(1.02); }
        
        .text-zone { position: relative; border: 1.5px solid var(--border); border-radius: 20px; background: rgba(15, 23, 42, 0.5); display: flex; flex-direction: column; flex: 1; min-height: 150px; backdrop-filter: blur(15px); overflow: hidden; }
        .text-zone.readonly { border-color: var(--success); background: rgba(16, 185, 129, 0.05); height: 200px; }

        .text-content-scroll { width: 100%; height: 100%; padding: 20px; overflow-y: auto; color: white; font-size: 14px; background: transparent; resize: none; border: none; box-sizing: border-box; }
        .text-content-scroll::-webkit-scrollbar { width: 6px; }
        .text-content-scroll::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 3px; }
        .text-content-scroll::-webkit-scrollbar-track { background: transparent; }

        textarea { background: transparent; border: none; color: white; resize: none; width: 100%; flex: 1; font-size: 14px; padding: 20px; margin: 0; outline: none; }

        .zone-badge { position: absolute; top: 10px; right: 12px; font-size: 10px; font-weight: 800; color: var(--text-muted); background: rgba(0,0,0,0.4); padding: 4px 8px; border-radius: 6px; pointer-events: none; border: 1px solid rgba(255,255,255,0.1); z-index: 10; backdrop-filter: blur(4px); }

        #stagedList { display: none; background: rgba(15, 23, 42, 0.6); border: 1px solid var(--border); border-radius: 12px; padding: 10px; margin-bottom: 10px; max-height: 120px; overflow-y: auto; }
        .staged-item { display: flex; justify-content: space-between; align-items: center; font-size: 12px; padding: 6px 10px; background: rgba(255,255,255,0.05); border-radius: 8px; margin-bottom: 5px; }
        
        #ai-suggestions { display: none; font-size: 13px; margin-bottom: 8px; background: rgba(139, 92, 246, 0.1); padding: 12px 14px; border-radius: 12px; border-left: 3px solid var(--ai); color: #e9d5ff; text-align: left; }
        #ai-tag-container { display: flex; gap: 6px; margin-top: 6px; flex-wrap: wrap; }
        .ai-smart-tag { font-size: 11px; padding: 3px 8px; border-radius: 6px; background: rgba(139, 92, 246, 0.3); color: white; border: 1px solid rgba(139, 92, 246, 0.4); }

        .text-action-row { display: flex; gap: 10px; align-items: stretch; margin-top: auto; }
        
        .split-btn { 
            flex: 0.4; min-width: 90px;
            display: flex; border: none; border-radius: 16px; 
            overflow: hidden; background: var(--primary); 
            box-shadow: 0 6px 20px rgba(99, 102, 241, 0.4); 
            transition: 0.3s; flex-shrink: 0;
        }
        .split-btn:active { transform: scale(0.97); }

        .tooltip-wrap { flex: 1; position: relative; display: flex; }
        .tooltip-wrap:hover::after, .tooltip-wrap:active::after {
            content: attr(data-tip);
            position: absolute; bottom: 120%; left: 50%; transform: translateX(-50%);
            background: rgba(0,0,0,0.9); color: white; padding: 6px 10px; font-size: 10px; border-radius: 6px;
            white-space: nowrap; pointer-events: none; z-index: 100;
            border: 1px solid rgba(255,255,255,0.2); opacity: 1; visibility: visible;
        }
        .tooltip-wrap::after { opacity: 0; visibility: hidden; transition: 0.2s; }

        .split-btn button { 
            width: 100%; height: 100%; border: none; background: transparent; 
            color: white; cursor: pointer; font-size: 16px; 
            display: flex; align-items: center; justify-content: center; padding: 0;
        }
        .split-btn button:hover { background: rgba(255,255,255,0.2); }
        .split-btn .separator { width: 1.5px; background: rgba(255,255,255,0.3); height: 60%; margin: auto 0; }
        
        #btn-share-text { margin-top: 0; flex: 1; }

        /* [Â§çÁî®‰∏éÂ¢ûÂº∫] ÈöêÁßÅË≠¶ÂëäÊ†∑Âºè */
        #ai-privacy-alert, #text-privacy-alert {
            display: none;
            margin-top: 10px;
            padding: 10px 12px;
            background: rgba(239, 68, 68, 0.15);
            border: 1px solid rgba(239, 68, 68, 0.4);
            border-radius: 12px;
            color: #fca5a5;
            font-size: 11px;
            font-weight: 600;
            line-height: 1.5;
            text-align: left;
            animation: pulse-red 3s infinite;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        @keyframes pulse-red { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } 70% { box-shadow: 0 0 0 5px rgba(239, 68, 68, 0.1); } 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }

        button.action-btn { background: var(--primary); color: white; border: none; padding: 16px; border-radius: 16px; font-size: 14px; cursor: pointer; width: 100%; font-weight: 800; transition: 0.3s; box-shadow: 0 6px 20px rgba(99, 102, 241, 0.4); margin-top: auto; text-transform: uppercase; }
        button.action-btn:active { transform: scale(0.97); }

        @keyframes blink { 0% { opacity: 1; } 50% { opacity: 0.4; } 100% { opacity: 1; } }
        .blink-warn { animation: blink 1.5s infinite ease-in-out; color: #f59e0b; margin: 0 10px; }

        .nerd-stats { display: flex; justify-content: space-between; font-size: 11px; color: var(--success); font-family: monospace; font-weight: 900; margin-bottom: 10px; align-items: center; }
        #receivedText-container { display: none; margin-top: 20px; width:100%; }
        .history-box { width: 100%; max-width: 600px; margin-top: 40px; padding: 0 15px; }
        .history-title { font-size: 13px; font-weight: 900; text-transform: uppercase; color: var(--text-muted); margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }
        .history-title::after { content:""; flex:1; height:1px; background: rgba(255,255,255,0.1); }
        .history-item { background: rgba(30, 41, 59, 0.5); border-radius: 14px; padding: 12px 18px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; border: 1px solid rgba(255,255,255,0.05); font-size: 11px; }

        #senderCodeArea { margin-top: 30px; border-top: 1px solid var(--border); padding-top: 30px; display: none; text-align: center; }
        .code-display { font-size: 72px; letter-spacing: 12px; font-weight: 900; color: #a5b4fc; margin: 20px 0; text-shadow: 0 0 40px rgba(99, 102, 241, 0.7); }
        #qrcode { background: white; padding: 15px; border-radius: 18px; display: inline-block; box-shadow: 0 0 30px rgba(255,255,255,0.15); }

        .receive-input-container { position: relative; width: 100%; max-width: 420px; display: flex; align-items: center; background: #0f172a; border: 2.5px solid var(--border); border-radius: 20px; overflow: hidden; }
        input[type="number"] { flex: 1; padding: 18px; border: none; background: transparent; color: white; font-size: 42px; text-align: center; outline: none; min-width: 0; }
        #btn-scan { background: transparent; border: none; border-left: 1.5px solid rgba(255,255,255,0.2); color: var(--text-muted); font-size: 14px; font-weight: 800; padding: 0 15px; height: 50px; cursor: pointer; white-space: nowrap; transition: 0.3s; }
        #btn-scan:hover { color: var(--primary); }

        .pg-container { width: 100%; height: 8px; background: rgba(255,255,255,0.1); border-radius: 10px; overflow: hidden; margin: 15px 0; display: none; position: relative; }
        .pg-bar { height: 100%; width: 0%; background: var(--primary); transition: width 0.3s; box-shadow: 0 0 10px var(--primary); }

        .pwd-group { display: flex; align-items: center; background: rgba(30, 41, 59, 0.5); border: 2px solid #334155; border-radius: 14px; margin-bottom: 5px; width: 100%; transition: 0.3s; position: relative; overflow: hidden; }
        .pwd-group:focus-within { border-color: var(--primary); box-shadow: 0 0 15px rgba(99, 102, 241, 0.2); background: rgba(30, 41, 59, 0.8); }
        .pwd-group input { flex: 1; background: transparent; border: none; color: white; padding: 16px; font-size: 16px; outline: none; letter-spacing: 1px; text-align: center; width: 100%; }
        .pwd-divider { width: 1px; height: 24px; background: rgba(255, 255, 255, 0.2); margin: 0 5px; }
        .pwd-toggle { padding: 0 15px; font-size: 20px; cursor: pointer; user-select: none; transition: transform 0.2s; filter: drop-shadow(0 0 5px rgba(0,0,0,0.5)); }
        .pwd-toggle:active { transform: scale(0.9); }

        /* [‰øÆÊîπ] FAQ ÂÆπÂô®ÔºöÈªòËÆ§ÁßªÂä®Á´ØÁ´ñÊéíÔºåPCÁ´ØÂèåÂàó */
        .faq-container { 
            max-width: 1000px; margin: 40px auto; padding: 0 20px; text-align: left; 
            display: grid; grid-template-columns: 1fr; gap: 15px;
        }
        .faq-container h3 { 
            font-size: 16px; color: var(--primary); margin-bottom: 20px; 
            text-transform: uppercase; letter-spacing: 1px; grid-column: 1 / -1; text-align: center; 
        }
        @media (min-width: 768px) { .faq-container { grid-template-columns: 1fr 1fr; align-items: start; } }

        details { background: rgba(30, 41, 59, 0.4); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 12px; margin-bottom: 0; padding: 12px 15px; transition: 0.3s; }
        details[open] { border-color: var(--primary); background: rgba(99, 102, 241, 0.1); }
        summary { font-size: 14px; font-weight: 800; color: white; cursor: pointer; list-style: none; display: flex; justify-content: space-between; align-items: center; }
        summary::after { content: '+'; color: var(--primary); font-size: 18px; transition: 0.3s; }
        details[open] summary::after { content: '-'; transform: rotate(90deg); }
        .faq-answer { font-size: 13px; color: var(--text-muted); margin-top: 10px; line-height: 1.6; padding-top: 10px; border-top: 1px dashed rgba(255, 255, 255, 0.1); }

        .legal-footer { padding: 15px 10px 30px 10px; background: #030712; border-top: 1px solid var(--border); display: flex; flex-direction: column; align-items: center; gap: 15px; }
        .trust-signals-grid { display: flex; flex-direction: row; justify-content: space-around; align-items: center; width: 100%; max-width: 600px; }
        .signal-item { display: flex; flex-direction: column; align-items: center; flex: 1; }
        .signal-item div { font-size: 28px; margin-bottom: 5px; filter: drop-shadow(0 0 10px #6366f1) drop-shadow(0 0 20px rgba(99, 102, 241, 0.7)); }
        .signal-item p { font-size: 11px; color: var(--text-muted); font-weight: 800; margin: 0; }
        .footer-links-container { display: flex; justify-content: center; align-items: center; gap: 30px; width: 100%; }
        .clickable-footer-link { cursor: pointer; display: inline-flex; align-items: center; gap: 6px; color: white; font-weight: 900; font-size: 16px; white-space: nowrap; text-shadow: 0 0 8px rgba(99, 102, 241, 0.5); }
        .clickable-footer-link::after { content: '‚ûî'; font-size: 13px; color: #6366f1; opacity: 0.9; display: inline-block; animation: arrowMove 1.5s infinite ease-in-out; }
        @keyframes arrowMove { 0%, 100% { transform: translateX(0); } 50% { transform: translateX(5px); } }
        .footer-info-block { width: 100%; border-top: 1px dashed rgba(255,255,255,0.1); padding-top: 10px; text-align: center; }
        .coffee-btn { display: inline-flex; align-items: center; gap: 8px; padding: 12px 24px; border: 1px solid var(--primary); border-radius: 12px; color: var(--primary); text-decoration: none; font-weight: 800; font-size: 12px; transition: 0.3s; margin-bottom: 25px; box-shadow: 0 0 15px rgba(99, 102, 241, 0.2); }
        .coffee-btn:hover { background: var(--primary); color: white; transform: translateY(-2px); }

        .policy-modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.85); backdrop-filter: blur(10px); z-index: 10000; display: none; justify-content: center; align-items: center; padding: 20px; }
        .policy-content { background: #111827; border: 1px solid var(--border); border-radius: 24px; max-width: 600px; width: 100%; max-height: 80vh; overflow-y: auto; padding: 30px; position: relative; box-shadow: 0 0 50px rgba(99, 102, 241, 0.2); }
        .policy-content h2 { color: var(--primary); margin-top: 0; font-size: 20px; }
        .policy-content p { line-height: 1.8; color: var(--text-muted); font-size: 14px; text-align: left; }
        .close-policy { position: absolute; top: 20px; right: 20px; cursor: pointer; font-size: 24px; color: var(--text-muted); font-weight: bold; }

        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.97); z-index: 5000; display: none; justify-content: center; align-items: center; flex-direction: column; padding: 20px; backdrop-filter: blur(15px); }
        #ad-wait-title { color:white; margin-bottom:10px; font-weight:bold; text-align:center; line-height:1.6; font-size:18px; }

        .protection-btn { display: inline-flex; align-items: center; justify-content: center; cursor: pointer; background: #1e293b; border: 1.5px solid #334155; border-radius: 8px; padding: 0 12px; height: 40px; min-width: 160px; font-weight: 700; font-size: 13px; transition: all 0.2s; margin-right: 10px; }
        .protection-btn input { display: none; }
        .protection-btn:has(input:checked) { background: #10b981; border-color: #10b981; box-shadow: 0 0 15px rgba(16, 185, 129, 0.4); }
        .protection-btn:has(input:checked) .state.off { display: none !important; }
        .protection-btn:has(input:checked) .state.on { display: flex !important; }

        /* ÈÄöÁî®ÂºπÁ™óÊ†∑Âºè */
        .crypto-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.85); z-index: 6000; display: none; justify-content: center; align-items: center; backdrop-filter: blur(8px); }
        .crypto-modal-card { background: #0f172a; padding: 30px; border-radius: 24px; border: 1px solid var(--border); width: 90%; max-width: 380px; box-shadow: 0 20px 60px rgba(99, 102, 241, 0.15); display: flex; flex-direction: column; gap: 15px; }
        
        .strength-wrapper { display: flex; align-items: center; gap: 10px; margin-bottom: 5px; width: 100%; }
        .strength-track { flex: 1; height: 6px; background: rgba(255, 255, 255, 0.1); border-radius: 3px; overflow: hidden; }
        #strength-bar-fill { height: 100%; width: 0%; background-color: #ef4444; border-radius: 3px; transition: width 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94), background-color 0.3s ease; box-shadow: 0 0 10px rgba(0,0,0,0.2); }
        #strength-text { font-size: 11px; font-weight: 800; color: #64748b; min-width: 60px; text-align: right; transition: color 0.3s ease; }

        #scanner-modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: #000; z-index: 10000; display: none; flex-direction: column; align-items: center; justify-content: center; overflow: hidden; }
        .scanner-container { position: relative; width: 100%; max-width: 450px; height: 70vh; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        #video-preview { width: 100%; height: 100%; object-fit: cover; border-radius: 24px; box-shadow: 0 0 30px rgba(99, 102, 241, 0.3); }
        
        .scan-frame { position: absolute; top: 20px; left: 20px; right: 20px; bottom: 20px; border: 2px solid rgba(99, 102, 241, 0.6); border-radius: 20px; overflow: hidden; pointer-events: none; box-shadow: inset 0 0 20px rgba(99, 102, 241, 0.2); }
        .scan-line { width: 100%; height: 3px; background: #6366f1; box-shadow: 0 0 15px #6366f1; animation: scanMove 2.5s infinite linear; position: absolute; top: 0; left: 0; }
        @keyframes scanMove { 0% { top: 0; opacity: 0; } 10% { opacity: 1; } 90% { opacity: 1; } 100% { top: 100%; opacity: 0; } }

        #btn-torch { position: absolute; top: 30px; right: 30px; width: 45px; height: 45px; border-radius: 50%; background: rgba(0,0,0,0.4); border: 1.5px solid white; color: white; font-size: 20px; cursor: pointer; backdrop-filter: blur(4px); display: flex; justify-content: center; align-items: center; z-index: 10001; }

        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-8px); } 75% { transform: translateX(8px); } }
        .input-error { border-color: #ef4444 !important; animation: shake 0.4s cubic-bezier(.36,.07,.19,.97) both; color: #ef4444 !important; }
        #pass-error-msg { min-height: 20px; font-size: 12px; color: #ef4444; text-align: center; font-weight: 800; margin-bottom: 5px; }

        .steps-bar { position: relative; display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; width: 100%; overflow: hidden; padding: 10px 0; }
        .steps-bar::after { content: ''; position: absolute; top: 0; left: 0; bottom: 0; right: 0; background: linear-gradient(90deg, transparent 0%, rgba(99, 102, 241, 0.2) 50%, transparent 100%); transform: translateX(-100%); animation: flowSweep 3s infinite ease-in-out; pointer-events: none; z-index: 0; }
        @keyframes flowSweep { 0% { transform: translateX(-100%); } 100% { transform: translateX(100%); } }
        
        .step-item { display: flex; flex-direction: column; align-items: center; gap: 8px; z-index: 1; position: relative; flex: 1; }
        .step-dot { width: 10px; height: 10px; border-radius: 50%; background: var(--text-muted); transition: 0.3s; box-shadow: 0 0 0 3px rgba(30, 41, 59, 1); }
        .step-item span { font-size: 10px; font-weight: 800; color: var(--text-muted); text-transform: uppercase; text-align: center; line-height: 1.2; }
        .step-line { flex: 0.5; height: 2px; background: rgba(255,255,255,0.1); margin: 0 5px; position: relative; top: -9px; z-index: 0; }
        
        .step-item:first-child .step-dot { background: var(--primary); box-shadow: 0 0 10px var(--primary); }
        .step-item:first-child span { color: white; }
    </style>
</head>
<body>

<div id="safety-notice-view">
    <div class="safety-card">
        <div class="icon">üõ°Ô∏è</div>
        <h3 id="safety-title">Privacy-First & Free</h3>
        <p id="safety-desc" class="safety-text">
            FlashDrop Pro runs entirely in your browser ‚Äî <strong>files never touch our servers</strong>. 
            We use minimal ads only to support the infrastructure and keep this P2P tool free for everyone. 
            Please support privacy by disabling your AdBlocker! ‚ù§Ô∏è
        </p>
        
        <button class="action-btn" id="btn-reload" onclick="location.reload()">I'VE DISABLED IT, RELOAD</button>
        
        <button class="action-btn" id="btn-ruthless" onclick="dismissAdBlock()" 
                style="background: transparent; border: 1.5px solid #374151; color: #9ca3af; margin-top: 12px; padding: 12px; font-size: 12px;">
            <span id="btn-ruthless-text">No thanks (Session only)</span>
        </button>

        <div style="margin-top: 20px; font-size: 11px; color: var(--text-muted); opacity: 0.6;">Efficiency & Privacy First.</div>
    </div>
</div>

<div class="app-container" id="app">
    <div class="stars-container" id="stars"></div>
    <nav class="navbar">
        <div class="logo-wrap">
            <div class="status-container">
                <div id="status-dot" class="status-dot online"></div>
                <div id="status-text" class="status-text online">Online</div>
            </div>
            
            <div class="logo">
    <img src="./image/logo.png" alt="FlashDrop Pro" style="height: 60px; width: auto; vertical-align: middle;">
</div>
            <div id="currentLangTag" style="font-size:11px; color:var(--primary); font-weight:900; margin-left:12px; border:1.5px solid var(--primary); padding:2px 6px; border-radius:6px;">EN</div>
        </div>

        <div class="search-wrapper" id="searchWidget" style="margin-top: 5px;">
            <div class="search-scope" id="searchScope" onclick="cycleSearchScope()">Global</div>
            <div class="search-ticker" onclick="toggleSearchDropdown()">
                <span class="ticker-text" id="searchTickerText">üî• Trending: AES-256 Security...</span>
            </div>
            <div class="search-divider"></div>
            <button class="search-btn" onclick="toggleSearchDropdown()">üîç</button>
            
            <div class="search-dropdown" id="searchDropdown">
                <div class="sd-header">üî• Everyone is searching</div>
                <div id="trendingList">
                    </div>
                <div class="sd-divider"></div>
                <div class="sd-header">üïí Recent History</div>
                <div id="searchHistoryTags"></div>
            </div>
        </div>
    </nav>
    <div id="drop-zone"><h2 style="font-size:36px; color:white; font-weight:900;" id="drop-text">DROP TO STAGE</h2></div>

    <div class="ad-space ad-top" id="top-ad-zone">
        <script>atOptions={'key':'fabada29768bc51cc0a6a76937a99ba9','format':'iframe','height':90,'width':728,'params':{}};</script>
        <script src="https://www.highperformanceformat.com/fabada29768bc51cc0a6a76937a99ba9/invoke.js"></script>
    </div>

    <div class="main-wrapper">
        <div class="ad-side" id="left-ad-zone">
            <script>atOptions={'key':'bd9abdb5a8bd5a53648a9afb54343727','format':'iframe','height':600,'width':160,'params':{}};</script>
            <script src="https://www.highperformanceformat.com/bd9abdb5a8bd5a53648a9afb54343727/invoke.js"></script>
            
            <script>atOptions={'key':'bd9abdb5a8bd5a53648a9afb54343727','format':'iframe','height':600,'width':160,'params':{}};</script>
            <script src="https://www.highperformanceformat.com/bd9abdb5a8bd5a53648a9afb54343727/invoke.js"></script>
        </div>

        <div class="content-area">
            <div style="text-align: center; margin-bottom: 25px;">
                <h1 id="hero-title" style="font-size: 26px; font-weight: 900; color: white; margin-bottom: 8px;">FlashDrop Pro ‚Äî Secure P2P File & Text Transfer</h1>
                <h2 id="hero-subtitle" style="font-size: 13px; color: var(--text-muted); line-height: 1.6; max-width: 550px; margin: 0 auto;">
                    No server storage. End-to-end encrypted. Files never touch the cloud.<br>
                    Share files & text directly between devices with optional password protection and self-destruct security.
                </h2>
                
                <div class="hero-bullets">
                    <span>üîí AES-256 Encrypted</span>
                    <span>üö´ No Cloud / Logs</span>
                    <span>üí• Auto-Destruct</span>
                    <span style="border-color: var(--ai); color: #d8b4fe; background: rgba(139, 92, 246, 0.15);">üì∑ Local OCR</span>
                </div>
            </div>

            <div class="steps-bar">
                <div class="step-item"><div class="step-dot"></div><span id="step-1">Select Files<br><span style="font-size:9px; opacity:0.7">(Type Text)</span></span></div>
                <div class="step-line"></div>
                <div class="step-item"><div class="step-dot"></div><span id="step-2">Set AES-256<br><span style="font-size:9px; opacity:0.7">(Option)</span></span></div>
                <div class="step-line"></div>
                <div class="step-item"><div class="step-dot"></div><span id="step-3">Get Code</span></div>
                <div class="step-line"></div>
                <div class="step-item"><div class="step-dot"></div><span id="step-4">Download</span></div>
            </div>
            <div class="card">
                <div class="tab-group"><div id="tab-send" class="tab active" onclick="switchTab('send', event)">Send</div><div id="tab-receive" class="tab" onclick="switchTab('receive', event)">Receive</div></div>
                
                <div id="panel-send" class="panel active">
                    <div class="share-grid">
                        <div class="column-box">
                            <label class="file-zone" id="file-drop-area" for="fileInput">
                                <div id="file-count-badge" class="zone-badge" style="display:none;">0 Files</div>
                                <div style="font-size: 42px;">üìÇ</div>
                                <div id="label-files" style="font-size:13px; margin-top:10px; font-weight:900;">Drop / Click</div>
                            </label>
                            
                            <div id="ai-suggestions" style="font-size: 13px;">
                                <div style="display:flex; flex-wrap:wrap; align-items:center; gap:5px; margin-bottom:5px;">
                                    <strong id="ai-title-file">‚ú® AI Insights</strong>
                                    <span id="ai-insight-note" style="font-size:10px; opacity:0.6;">(Selected types)</span>
                                    <span id="ai-local-file" style="font-size:9px; opacity:0.7; margin-left:auto;">Local Processing</span>
                                </div>
                                <div id="ai-privacy-alert"></div>
                                <div id="ai-tag-container"></div>
                            </div>
                            
                            <div id="stagedList"></div>
                            <button class="action-btn" id="btn-share-files" onclick="triggerAd('send-file')">SHARE FILES</button>
                        </div>
                        <div class="column-box">
                            <div class="text-zone">
                                <div id="text-count-badge" class="zone-badge" style="display:none;">0 Chars</div>
                                <div id="label-text-hint" style="font-size:12px; color:var(--text-muted); font-weight:900; margin: 20px 0 0 20px;">Quick Text</div>
                                <textarea id="quickText" placeholder="Paste..." oninput="updateTextCount(this); checkTextPrivacy(this.value)"></textarea>
                            </div>
                            
                            <div id="text-ai-suggestions" style="display:none; font-size: 13px; margin-bottom: 5px; background: rgba(139, 92, 246, 0.1); padding: 12px 14px; border-radius: 12px; border-left: 3px solid var(--ai); color: #e9d5ff; text-align: left;">
                                <div style="display:flex; flex-wrap:wrap; align-items:center; gap:5px; margin-bottom:5px;">
                                    <strong id="ai-title-text">‚ú® AI Analysis</strong>
                                    <span id="ai-local-text" style="font-size:9px; opacity:0.7; margin-left:auto;">Local Processing</span>
                                </div>
                                <div id="text-privacy-alert"></div>
                            </div>

                            <div class="text-action-row">
                                <div class="split-btn">
                                    <div class="tooltip-wrap" id="tip-scan" data-tip="Scan / Paste">
                                        <button id="btn-ocr-paste" onclick="triggerOCRAd('scan')">üì∑</button>
                                    </div>
                                    <div class="separator"></div>
                                    <div class="tooltip-wrap" id="tip-upload" data-tip="Upload Image">
                                        <button id="btn-ocr-upload" onclick="triggerOCRAd('upload')">üìÇ</button>
                                    </div>
                                </div>
                                <button class="action-btn" id="btn-share-text" onclick="triggerAd('send-text')">SHARE TEXT</button>
                            </div>
                            <input type="file" id="ocrInput" accept="image/*" style="display:none;" onchange="handleOCRFiles(this.files)">
                        </div>
                    </div>

                    <div style="display:flex; align-items:center; justify-content:center; gap:15px; margin: 15px 0; flex-wrap:wrap;">
                        <label class="protection-btn" onclick="event.preventDefault(); showCryptoModal()">
                            <input type="checkbox" id="protection-toggle-input"> <span class="btn-content">
                                <span class="state off" style="color:#f59e0b; display:flex; align-items:center; gap:6px;">
                                    <span>‚ö†Ô∏è</span> <span id="aes-off-txt">AES-256 OFF</span>
                                </span>
                                <span class="state on" style="color:#fff; display:none; align-items:center; gap:6px;">
                                    <span>üõ°Ô∏è</span> <span id="aes-on-txt">AES-256 ON</span>
                                </span>
                            </span>
                        </label>

                        <div id="crypto-modal" class="crypto-modal">
                            <div class="crypto-modal-card">
                                <h3 id="modal-pass-title" style="color: #6366f1; margin: 0 0 10px 0; font-size: 18px;">Set Password</h3>
                                
                                <div class="pwd-group">
                                    <input type="password" id="crypto-password" placeholder="Type a strong password..." 
                                           oninput="checkStrength(this.value)" 
                                           onkeyup="updateFingerprint(this.value, 'send-fingerprint', 'send-hash-hint')" 
                                           autocomplete="new-password">
                                    <div class="pwd-divider"></div>
                                    <div class="pwd-toggle" onclick="togglePwd('crypto-password', this)">üôà</div>
                                </div>
                                
                                <p id="send-hash-hint" style="display:none; font-size:10px; color:#94a3b8; margin: 8px 0 2px 0; text-align:center; line-height:1.4; opacity:0.8;"></p>
                                
                                <div id="send-fingerprint" style="display:none; text-align: center; font-size: 24px; letter-spacing: 8px; margin: 5px 0; min-height: 36px; filter: drop-shadow(0 0 10px rgba(99, 102, 241, 0.5));"></div>

                                <div class="strength-wrapper">
                                    <div class="strength-track">
                                        <div id="strength-bar-fill"></div>
                                    </div>
                                    <div id="strength-text" style="opacity:0.8">Empty</div>
                                </div>
                                <div style="display: flex; gap: 10px; margin-top: 10px;">
                                    <button class="action-btn" id="btn-enable-pass" style="flex: 1; padding: 12px; margin:0;" onclick="confirmEncryption()">ENABLE</button>
                                    <button class="action-btn" id="btn-cancel-pass" style="flex: 1; padding: 12px; background: #334155; margin:0;" onclick="closeCryptoModal()">CANCEL</button>
                                </div>
                            </div>
                        </div>

                        <div style="display:flex; align-items:center; gap:8px;">
                            <span id="limit-label" style="font-size:13px; color:#94a3b8; font-weight:700;">Limit:</span>
                            <select id="downloadLimit" style="background:#0f172a; color:#fff; border:1.5px solid var(--border); padding:0 10px; border-radius:8px; outline:none; height:40px; font-weight:600;">
                                <option value="1">1 Time</option>
                                <option value="3">3 Times</option>
                                <option value="5">5 Times</option>
                                <option value="999">Unlimited</option>
                            </select>
                        </div>
                    </div>
                    <input type="file" id="fileInput" multiple style="display:none;" onchange="handleFiles(this.files)">
                    <div id="senderCodeArea">
                        <div style="font-size:12px; color:var(--success); font-weight:900; margin-bottom:15px;">üõ°Ô∏è P2P ENCRYPTED</div>
                        <p id="guideText" style="font-size:13px; color:var(--primary); font-weight:800; margin-bottom:18px; line-height:1.5;"></p>
                        <div id="qrcode"></div>
                        <div class="code-display" id="myCode">000000</div>
                        <div id="expiryTimer" style="font-size:13px; color:var(--danger); font-weight:900; margin-top:10px;">Expires: 10:00</div>
                        <button class="action-btn" id="btn-copy-link" style="background:#4f46e5; margin-top:15px;">üìã COPY LINK</button>
                        <button class="action-btn" id="btn-stop" onclick="resetSender()" style="background:var(--danger); margin-top:15px;">STOP</button>
                    </div>
                </div>
                
                <div id="panel-receive" class="panel">
                    <div style="display:flex; flex-direction:column; align-items:center;">
                        <div class="receive-input-container">
                            <input type="number" id="targetCode" placeholder="000000" oninput="if(this.value.length>6) this.value=this.value.slice(0,6)" onkeydown="if(event.key==='Enter') triggerAd('receive')">
                            <button id="btn-scan" onclick="openScanner()">or scan üì∑</button>
                        </div>
                        
                        <button class="action-btn" id="btn-connect" onclick="triggerAd('receive')" style="margin-top: 25px;">DOWNLOAD</button>
                        
                        <div id="receive-pg-container" class="pg-container"><div id="receive-pg-bar" class="pg-bar"></div></div>
                        <div id="receiveNerdStats" class="nerd-stats" style="display:none; width:100%; margin-top:5px;"><span id="nerd-speed">0.0 MB/s</span><span class="blink-warn">Downloading... Keep Open!</span><span id="nerd-eta" style="color:var(--primary)">ETA: --s</span></div>
                        
                        <div id="receivedText-container">
                            <div class="text-zone readonly">
                                <div id="recv-text-count" class="zone-badge" style="display:none;">0 Chars</div>
                                <div id="recv-scroll-box" class="text-content-scroll">
                                    <div id="receivedText" style="white-space: pre-wrap; word-break: break-all;"></div>
                                </div>
                            </div>
                            <button class="action-btn" id="btn-copy-text" onclick="copyReceivedText()" style="margin-top: 15px;">üìã COPY</button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="history-box"><div class="history-title" id="history-title-text">Recent History</div><div id="history-list"></div></div>
            
            <div class="ad-space ad-bottom" id="bottom-ad-zone">
                <script>atOptions={'key':'fabada29768bc51cc0a6a76937a99ba9','format':'iframe','height':90,'width':728,'params':{}};</script>
                <script src="https://www.highperformanceformat.com/fabada29768bc51cc0a6a76937a99ba9/invoke.js"></script>
            </div>
        </div>

        <div class="ad-side" id="right-ad-zone">
            <script>atOptions={'key':'bd9abdb5a8bd5a53648a9afb54343727','format':'iframe','height':600,'width':160,'params':{}};</script>
            <script src="https://www.highperformanceformat.com/bd9abdb5a8bd5a53648a9afb54343727/invoke.js"></script>
            
            <script>atOptions={'key':'bd9abdb5a8bd5a53648a9afb54343727','format':'iframe','height':600,'width':160,'params':{}};</script>
            <script src="https://www.highperformanceformat.com/bd9abdb5a8bd5a53648a9afb54343727/invoke.js"></script>
        </div>
    </div>
    <div style="width: 100%; max-width: 900px; margin: 0 auto; padding: 0 15px;">
        <div class="security-grid">
            <div class="sec-card">
                <h3 id="sec-fp-title">üîê Security Fingerprint</h3>
                <div class="fingerprint-demo">
                    <span style="opacity:0.7; font-size:12px;">Send:</span> ‚ö°üõ°Ô∏èüöÄüê± <br>
                    <span style="opacity:0.7; font-size:12px;">Recv:</span> ‚ö°üõ°Ô∏èüöÄüê±
                </div>
                <p id="sec-fp-desc">Visual verification prevents Man-in-the-Middle attacks. If emojis match, the line is secure.</p>
            </div>
            
            <div class="sec-card">
                <h3 id="sec-ai-title">üß† AI Privacy Guard</h3>
                <p style="font-size:10px; color:#a5b4fc; margin-bottom:8px; font-weight:700;">(Runs 100% Locally / No Upload)</p>
                <ul id="sec-ai-list">
                    <li>Detects IDs, Cards, Private Keys</li>
                    <li>Warns BEFORE you send</li>
                    <li>Suggests AES-256 automatically</li>
                </ul>
            </div>
            
            <div class="sec-card">
                <h3 id="sec-burn-title">üî• Security Burn‚Ñ¢</h3>
                <p id="sec-burn-desc">Wrong password 3 times = Connection DESTROYED instantly. Data gone forever.</p>
                <div style="margin-top:12px; border-top:1px dashed rgba(255,255,255,0.1); padding-top:10px;">
                    <h3 style="font-size:13px; color:#10b981;" id="sec-access-title">üéØ Controlled Access</h3>
                    <p id="sec-access-desc">Limit downloads (1/3/5 times). Expired links become invalid immediately.</p>
                </div>
            </div>
        </div>
    </div>

    <div class="ad-space" id="faq-top-ad" style="margin: 40px auto 10px auto; max-width: 728px; display:flex; justify-content:center;">
        <script>atOptions={'key':'fabada29768bc51cc0a6a76937a99ba9','format':'iframe','height':90,'width':728,'params':{}};</script>
        <script src="https://www.highperformanceformat.com/fabada29768bc51cc0a6a76937a99ba9/invoke.js"></script>
    </div>

    <footer class="legal-footer">
        <div class="faq-container">
            <h3 id="faq-title">Common Questions</h3>
            <details><summary id="faq-q1">...</summary><div class="faq-answer" id="faq-a1">...</div></details>
            <details><summary id="faq-q2">...</summary><div class="faq-answer" id="faq-a2">...</div></details>
            <details><summary id="faq-q3">...</summary><div class="faq-answer" id="faq-a3">...</div></details>
            <details><summary id="faq-q4">...</summary><div class="faq-answer" id="faq-a4">...</div></details>
            <details><summary id="faq-q5">...</summary><div class="faq-answer" id="faq-a5">...</div></details>
            <details><summary id="faq-q6">...</summary><div class="faq-answer" id="faq-a6">...</div></details>
            <details><summary id="faq-q7">...</summary><div class="faq-answer" id="faq-a7">...</div></details>
            <details><summary id="faq-q8">...</summary><div class="faq-answer" id="faq-a8">...</div></details>
            <details><summary id="faq-q9">...</summary><div class="faq-answer" id="faq-a9">...</div></details>
        </div>

        <div style="margin-bottom: 5px;">
            <a href="https://buymeacoffee.com/xiaevan199e" target="_blank" class="coffee-btn" style="box-shadow: 0 0 15px rgba(99, 102, 241, 0.3);">‚òï <span id="foot-coffee">Buy me a coffee</span></a>
        </div>

        <div class="trust-signals-grid">
            <div class="signal-item"><div>‚ö°</div><p id="signal-1">No Limits</p></div>
            <div class="signal-item"><div>üîê</div><p id="signal-2">P2P Only</p></div>
            <div class="signal-item"><div>üìÇ</div><p id="signal-3">Auto-Wipe</p></div>
        </div>

        <div class="footer-links-container">
            <h4 class="clickable-footer-link" id="link-priv" onclick="window.location.href='privacy.html'">Privacy</h4>
            <h4 class="clickable-footer-link" id="link-site" onclick="window.location.href='about-side.html'">About Site</h4>
            <h4 class="clickable-footer-link" id="link-us" onclick="window.location.href='about-us.html'">About Us</h4>
        </div>

        <div class="footer-info-block">
            <p style="margin: 3px 0; font-weight: 800; font-size: 11px; color:white;">¬© 2025-2026 FlashDrop Pro. All rights reserved.</p>
            <p style="margin: 0; opacity: 0.7; font-size: 10px;">Privacy-first P2P Workspace.</p>
        </div>
    </footer>
</div>

<div id="policyModal" class="policy-modal" onclick="closePolicy()">
    <div class="policy-content" onclick="event.stopPropagation()">
        <span class="close-policy" onclick="closePolicy()">√ó</span>
        <div id="policyBody"></div>
    </div>
</div>

<div class="modal-overlay" id="adModal">
    <div id="ad-wait-title" style="max-width: 300px; line-height: 1.4;">To support the developer, please keep this ad open.</div>
    <div style="font-size: 13px; color: var(--primary); font-weight: 800; margin-bottom: 5px;" id="ad-timer-text">Remaining: 5s</div>
    <div style="width: 300px; height: 6px; background: rgba(255,255,255,0.1); border-radius: 4px; overflow: hidden; margin-bottom: 20px;">
        <div id="ad-pg-bar" style="height: 100%; width: 0%; background: var(--primary); transition: width 0.1s linear;"></div>
    </div>
    <div id="ad-container" style="width:300px; height:250px; background:white; border-radius:20px; overflow:hidden;">
        <script>atOptions={'key':'05aeca9dfc228cb50e7ad828813cd55b','format':'iframe','height':250,'width':300,'params':{}};</script>
        <script src="https://www.highperformanceformat.com/05aeca9dfc228cb50e7ad828813cd55b/invoke.js"></script>
    </div>
</div>

<div class="modal-overlay" id="ocrAdModal" style="z-index: 9999;">
    <div id="ocr-ad-title" style="color:white; margin-bottom:10px; font-weight:bold; text-align:center; line-height:1.4; font-size:18px; max-width: 300px;">To support the developer, please keep this ad open.</div>
    <div style="font-size: 13px; color: var(--ai); font-weight: 800; margin-bottom: 5px;" id="ocr-timer-text">Remaining: 5s</div>
    <div style="width: 300px; height: 6px; background: rgba(255,255,255,0.1); border-radius: 4px; overflow: hidden; margin-bottom: 20px;">
        <div id="ocr-pg-bar" style="height: 100%; width: 0%; background: var(--ai); transition: width 0.1s linear;"></div>
    </div>
    <div id="ocr-ad-container" style="width:300px; height:250px; background:white; border-radius:20px; overflow:hidden;">
        <script>atOptions={'key':'05aeca9dfc228cb50e7ad828813cd55b','format':'iframe','height':250,'width':300,'params':{}};</script>
        <script src="https://www.highperformanceformat.com/05aeca9dfc228cb50e7ad828813cd55b/invoke.js"></script>
    </div>
</div>

<div class="modal-overlay" id="ocrLoadingModal" style="z-index: 10000;">
    <div style="font-size: 40px; margin-bottom: 15px; animation: spin 2s infinite linear;">‚öôÔ∏è</div>
    <div id="ocr-loading-text" style="color:white; font-weight:bold; font-size:16px;">Reading Text...</div>
    <div style="font-size:12px; color:var(--text-muted); margin-top:5px;">Running locally in browser</div>
</div>
<style>@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }</style>

<div id="alert-modal" class="crypto-modal" style="z-index: 99999;">
    <div class="crypto-modal-card" style="align-items: center; text-align: center;">
        <div style="font-size: 40px; margin-bottom: 10px;">‚ö†Ô∏è</div>
        <h3 id="alert-msg" style="color: white; margin: 0 0 20px 0; font-size: 16px; line-height: 1.5;">Message</h3>
        <button class="action-btn" onclick="document.getElementById('alert-modal').style.display='none'" style="padding: 12px;">OK</button>
    </div>
</div>

<div id="pass-input-modal" class="crypto-modal" style="z-index: 99999;">
    <div class="crypto-modal-card">
        <h3 id="pass-input-title" style="color: #f59e0b; margin: 0 0 5px 0; font-size: 18px; text-align: center;">üîê Enter Password</h3>
        <div id="pass-error-msg"></div>
        <div class="pwd-group">
            <input type="password" id="alert-password-input" placeholder="Type password..." style="text-align: center;" 
                   onkeyup="updateFingerprint(this.value, 'recv-fingerprint', 'recv-hash-hint')">
            <div class="pwd-divider"></div>
            <div class="pwd-toggle" onclick="togglePwd('alert-password-input', this)">üôà</div>
        </div>
        <p id="recv-hash-hint" style="display:none; font-size:10px; color:#94a3b8; margin: 8px 0 2px 0; text-align:center; line-height:1.4; opacity:0.8;"></p>
        <div id="recv-fingerprint" style="display:none; text-align: center; font-size: 24px; letter-spacing: 8px; margin: 5px 0; min-height: 36px; filter: drop-shadow(0 0 10px rgba(245, 158, 11, 0.5));"></div>
        <div style="display: flex; gap: 10px; margin-top: 10px;">
            <button class="action-btn" id="btn-pass-confirm" style="flex: 1; padding: 12px; margin:0; background: #f59e0b;">UNLOCK</button>
            <button class="action-btn" id="btn-pass-cancel" style="flex: 1; padding: 12px; background: #334155; margin:0;">CANCEL</button>
        </div>
    </div>
</div>

<div id="scanner-modal">
    <div class="scanner-container">
        <video id="video-preview" playsinline></video>
        <div class="scan-frame"><div class="scan-line"></div></div>
        <button id="btn-torch" onclick="toggleTorch()">üî¶</button>
    </div>
    <button class="action-btn" style="width:180px; background:#334155; margin-top: 20px; z-index:10002;" onclick="closeScanner()">CLOSE</button>
</div>

<script>
    function togglePwd(inputId, btn) { const input = document.getElementById(inputId); if (input.type === "password") { input.type = "text"; btn.innerText = "üôâ"; } else { input.type = "password"; btn.innerText = "üôà"; } }
    async function updateFingerprint(val, elId, hintId) { const el = document.getElementById(elId); const hint = document.getElementById(hintId); if (!val) { el.innerText = ""; el.style.display = 'none'; if(hint) hint.style.display = 'none'; return; } el.style.display = 'block'; if(hint) hint.style.display = 'block'; const msgBuffer = new TextEncoder().encode(val); const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer); const hashArray = Array.from(new Uint8Array(hashBuffer)); const emojis = ["‚ö°","üõ°Ô∏è","üöÄ","ü§ñ","üíé","üî•","üåü","üåä","üêØ","üêµ","üçé","üçÄ","üé≤","üß©","üîÆ","üéµ","üé©","üëª","üåµ","üçï","üåô","‚òÄÔ∏è","üåà","‚ùÑÔ∏è"]; let res = ""; for(let i=0; i<4; i++) { res += emojis[hashArray[i] % emojis.length]; } el.innerText = res; }

    /* --- [NEW] Search Widget Logic --- */
    const SearchWidget = {
        // Mock trending topics
        trending: [
            "How to use AES-256 for free?", "Send 10GB file without login", "Is FlashDrop safer than AirDrop?", 
            "Local OCR privacy guide", "P2P vs Cloud storage", "Offline file sharing tips",
            "Generate strong passwords easily", "Prevent Man-in-the-Middle attacks"
        ],
        history: JSON.parse(localStorage.getItem('fd_search_history') || "[]"),
        scope: "Global",
        tickerIdx: 0,
        interval: null,
        
        init() {
            this.renderTicker();
            this.startRotation();
            this.renderDropdown();
        },
        
        startRotation() {
            if(this.interval) clearInterval(this.interval);
            this.interval = setInterval(() => {
                this.tickerIdx = (this.tickerIdx + 1) % this.trending.length;
                this.renderTicker();
            }, 4000);
        },
        
        renderTicker() {
            const el = document.getElementById('searchTickerText');
            // Trigger reflow for animation restart
            el.style.animation = 'none';
            el.offsetHeight; 
            el.style.animation = 'slideUp 0.5s ease-out';
            el.innerText = "üî• " + this.trending[this.tickerIdx];
        },
        
        toggleDropdown() {
            const dd = document.getElementById('searchDropdown');
            const wrap = document.getElementById('searchWidget');
            const ticker = document.getElementById('searchTickerText');
            
            if (dd.style.display === 'flex') {
                dd.style.display = 'none';
                wrap.classList.remove('active');
                this.startRotation();
            } else {
                dd.style.display = 'flex';
                wrap.classList.add('active');
                clearInterval(this.interval);
                ticker.innerText = "üîç Search: " + this.trending[this.tickerIdx]; 
            }
        },
        
        selectItem(text) {
            // Mock opening a post
            const ticker = document.getElementById('searchTickerText');
            ticker.innerText = "Opening: " + text + "...";
            setTimeout(() => {
                showCustomAlert("Opened post: " + text);
                this.addToHistory(text);
                this.toggleDropdown();
            }, 600);
        },
        
        addToHistory(text) {
            this.history = this.history.filter(i => i !== text); 
            this.history.unshift(text);
            if(this.history.length > 5) this.history.pop();
            localStorage.setItem('fd_search_history', JSON.stringify(this.history));
            this.renderDropdown();
        },
        
        renderDropdown() {
            const tList = document.getElementById('trendingList');
            const hList = document.getElementById('searchHistoryTags');
            
            tList.innerHTML = this.trending.slice(0, 5).map((t, i) => `
                <div class="sd-item" onclick="SearchWidget.selectItem('${t}')">
                    <span class="sd-rank rank-${i+1}">${i+1}</span>
                    <span>${t}</span>
                </div>
            `).join('');
            
            if (this.history.length === 0) {
                hList.innerHTML = '<span style="font-size:11px; color:#64748b; padding-left:10px;">No recent history</span>';
            } else {
                hList.innerHTML = this.history.map(h => `
                    <span class="history-tag" onclick="SearchWidget.selectItem('${h}')">${h}</span>
                `).join('');
            }
        },
        
        cycleScope() {
            const scopes = ["Global", "Local", "Friends", "Saved"];
            let curr = scopes.indexOf(this.scope);
            this.scope = scopes[(curr + 1) % scopes.length];
            document.getElementById('searchScope').innerText = this.scope;
        }
    };

    function toggleSearchDropdown() { SearchWidget.toggleDropdown(); }
    function cycleSearchScope() { SearchWidget.cycleScope(); }

<script>
    /* --- [1. ÂÆåÊï¥ËØ≠Ë®ÄÂåÖÈÖçÁΩÆ] --- */
    const I18N = {
        en: { 
            tag: "EN", on: "Online", off: "Offline",
            adWait: "To support the developer, please keep this ad open.",
            secFpTitle: "üîê Security Fingerprint", secFpDesc: "Visual verification prevents Man-in-the-Middle attacks.",
            secAiTitle: "üß† AI Privacy Guard", secAiList: "<li>Detects IDs, Cards, Keys</li><li>Warns BEFORE you send</li><li>Suggests AES-256 automatically</li>",
            secBurnTitle: "üî• Security Burn‚Ñ¢", secBurnDesc: "3 wrong password attempts = Connection DESTROYED instantly.", secAccessTitle: "üéØ Controlled Access", secAccessDesc: "Limit downloads & Auto-expiration.",
            tabSend: "Send", tabReceive: "Receive", badges: ["üîí P2P Encrypted", "üïµÔ∏è No Logs", "‚ö° High Speed", "üìÇ Auto-Wipe"], drop: "DROP TO STAGE", fileLab: "Drop / Click", shareF: "SHARE FILES", shareT: "SHARE TEXT", connect: "DOWNLOAD", save: "üì• SAVE", recv: "RECEIVE", decryptRecv: "üîì DECRYPT & VIEW", decryptSave: "üîì DECRYPT & SAVE", saveNow: "üíæ SAVE NOW", exp: "Expires: ", copyLink: "üìã COPY LINK", stop: "STOP", guide: "Scan QR or enter code on receiver device.", coffee: "Buy me a coffee", hPriv: "Privacy", hSite: "About Site", hUs: "About Us", inputErr: "Enter 6-digit code.", orScan: "or scan üì∑", doneRemind: "DONE! Click SAVE above.", histTitle: "Recent History", fileErr: "Please select files first.", textErr: "Please enter text first.",
            passTitle: "üîê Enter Password", passPlaceholder: "Type password...", passUnlock: "UNLOCK", passCancel: "CANCEL", passWrong: "Wrong Password!", passRemaining: "attempts left", passWeak: "For safety: 8+ chars, 1 Upper, 1 Lower, 1 Number, 1 Symbol.", hashHintSend: "Visual Check: If receiver's emojis match these, the key is correct!", hashHintRecv: "Visual Check: If the key matches, the emojis will match!",
            aiNote: "(Selected types)", privWarn: "‚ö†Ô∏è Privacy Alert: Filenames indicate sensitive info. AES-256 recommended!",
            ocrDone: "‚úÖ Text Extracted!", ocrAdTitle: "Local OCR Processing... Please wait.", ocrScanTip: "Scan / Paste", ocrUploadTip: "Upload Image",
            textPrivWarn: "üõ°Ô∏è Security Alert: Potential password, key, passport or card number detected. AES-256 is highly recommended!",
            step1: "Select Files<br><span style='font-size:9px; opacity:0.7'>(Type Text)</span>", step2: "Set AES-256<br><span style='font-size:9px; opacity:0.7'>(Option)</span>", step3: "Get Code", step4: "Download",
            heroTitle: "FlashDrop Pro ‚Äî Secure P2P File & Text Transfer", heroSub: "No server storage. End-to-end encrypted. Files never touch the cloud.<br>Share files & text directly between devices with optional password protection and self-destruct security.", sig1: "No Limits", sig2: "P2P Only", sig3: "Auto-Wipe", modalTitle: "Set Password", btnEnable: "ENABLE", btnCancel: "CANCEL", aesOff: "AES-256 OFF", aesOn: "AES-256 ON", btnRuthless: "Ruthless Refusal (Session only)", strengthLevels: ["Very Weak", "Weak", "Medium", "Moderate", "Strong", "Very Strong", "Unbreakable"], faqTitle: "Common Questions", aiInsight: "‚ú® AI Insights", aiLocal: "Local Processing", aiTags: { img: "üñºÔ∏è Image", vid: "üé¨ Video", doc: "üìÑ Document", code: "üíª Code", zip: "üì¶ Archive", big: "üêò Large File" },
            faqQ1: "Do my files pass through your servers?", faqA1: "No. FlashDrop Pro utilizes a serverless P2P architecture powered by WebRTC.", faqQ2: "Do you retain any logs or metadata?", faqA2: "Absolutely not. We operate on a 'Zero-Knowledge' basis.", faqQ3: "What encryption standards are used?", faqA3: "All transfers are secured via WebRTC's DTLS/SRTP. Optional password protection adds AES-256-GCM.", faqQ4: "Is my IP address visible?", faqA4: "Due to P2P nature, the recipient needs your IP to connect. Use VPN for anonymity.", faqQ5: "Is it safe for confidential documents?", faqA5: "Yes. Data never rests on a third-party server.", faqQ6: "Can I recover files after closing tab?", faqA6: "No. Data exists only in RAM. Once closed, it is lost forever.", faqQ7: "Can staff access my files?", faqA7: "Impossible. We have no keys and no storage.", faqQ8: "Is password mandatory?", faqA8: "Optional, but recommended for sensitive data on local networks.", faqQ9: "Can you reset lost password?", faqA9: "No. We don't store passwords."
        },
        zh: { 
            tag: "CN", on: "Âú®Á∫ø", off: "Á¶ªÁ∫ø",
            adWait: "‰∏∫‰∫ÜÊîØÊåÅÂºÄÂèëËÄÖÔºåËØ∑‰∏çË¶ÅÂÖ≥Èó≠ÂπøÂëäÁïåÈù¢„ÄÇ",
            secFpTitle: "üîê ÂÆâÂÖ®ÊåáÁ∫πÈ™åËØÅ", secFpDesc: "ÂèØËßÜÂåñÈ™åËØÅÈò≤Ê≠¢‰∏≠Èó¥‰∫∫ÊîªÂáª„ÄÇEmoji ‰∏ÄËá¥Âç≥ÂÆâÂÖ®„ÄÇ",
            secAiTitle: "üß† AI ÈöêÁßÅÂç´Â£´", secAiList: "<li>Ëá™Âä®Ê£ÄÊµãËØÅ‰ª∂„ÄÅÂç°Âè∑„ÄÅÁßÅÈí•</li><li>ÂèëÈÄÅÂâçÂèëÂá∫Ë≠¶Âëä</li><li>Ëá™Âä®Âª∫ËÆÆ AES-256 Âä†ÂØÜ</li>",
            secBurnTitle: "üî• Security Burn‚Ñ¢", secBurnDesc: "ÂØÜÁ†ÅÈîôËØØ 3 Ê¨° = ËøûÊé•Á´ãÂç≥ÈîÄÊØÅ„ÄÇÊï∞ÊçÆÊ∞∏‰πÖÊ∂àÂ§±„ÄÇ", secAccessTitle: "üéØ ËÆøÈóÆÊéßÂà∂", secAccessDesc: "ÈôêÂà∂‰∏ãËΩΩÊ¨°Êï∞ (1/3/5) ÂèäËá™Âä®ËøáÊúü„ÄÇ",
            tabSend: "ÂèëÈÄÅ", tabReceive: "Êé•Êî∂", badges: ["üîí P2P Âä†ÂØÜ", "üïµÔ∏è Èõ∂Êó•Âøó", "‚ö° ÊûÅÈÄü‰º†Ëæì", "üìÇ ÈòÖÂêéÂç≥ÁÑö"], drop: "ÊùæÊâã‰∏ä‰º†", fileLab: "ÊãñÊãΩ / ÁÇπÂáª", shareF: "ÂàÜ‰∫´Êñá‰ª∂", shareT: "ÂàÜ‰∫´ÊñáÂ≠ó", connect: "Á´ãÂç≥‰∏ãËΩΩ", save: "üì• ‰øùÂ≠òÊñá‰ª∂", recv: "üëÄ Êü•ÁúãÊñáÂ≠ó", decryptRecv: "üîì Ëß£ÂØÜÂπ∂Êü•Áúã", decryptSave: "üîì Ëß£ÂØÜÂπ∂‰øùÂ≠ò", saveNow: "üíæ ÁÇπÂáª‰øùÂ≠ò", exp: "ÊúâÊïàÊúü: ", copyLink: "üìã Â§çÂà∂ÈìæÊé•", stop: "ÂÅúÊ≠¢ÂàÜ‰∫´", guide: "ËØ∑ÂØπÊñπÊâ´Êèè‰∫åÁª¥Á†ÅÊàñËæìÂÖ•‰∏ãÊñπÈ™åËØÅÁ†Å„ÄÇ", coffee: "ËØ∑ÊàëÂñùÊùØÂíñÂï°", hPriv: "ÈöêÁßÅÊîøÁ≠ñ", hSite: "ÂÖ≥‰∫éÁΩëÁ´ô", hUs: "ÂÖ≥‰∫éÊàë‰ª¨", inputErr: "ËØ∑ËæìÂÖ•6‰ΩçÈ™åËØÅÁ†Å„ÄÇ", orScan: "Êâ´Á†ÅÊé•Êî∂ üì∑", doneRemind: "‰º†ËæìÂÆåÊàêÔºÅÁÇπÂáª‰∏äÊñπÊåâÈíÆ‰øùÂ≠ò„ÄÇ", histTitle: "ÊúÄËøëËÆ∞ÂΩï", fileErr: "ËØ∑ÂÖàÈÄâÊã©Êñá‰ª∂„ÄÇ", textErr: "ËØ∑ÂÖàËæìÂÖ•ÊñáÂ≠ó„ÄÇ",
            passTitle: "üîê ËæìÂÖ•ÂØÜÁ†Å", passPlaceholder: "Âú®Ê≠§ËæìÂÖ•...", passUnlock: "Ëß£ÈîÅ", passCancel: "ÂèñÊ∂à", passWrong: "‚ùå ÂØÜÁ†ÅÈîôËØØÔºÅ", passRemaining: "Ê¨°Â∞ùËØïÊú∫‰ºö„ÄÇ", passWeak: "‰∏∫‰∫ÜÂÆâÂÖ®ÔºöËá≥Â∞ë8‰ΩçÔºåÈúÄÂåÖÂê´Â§ßÂÜô„ÄÅÂ∞èÂÜô„ÄÅÊï∞Â≠óÂèäÁ¨¶Âè∑„ÄÇ", hashHintSend: "AES-256ÂØÜÈí•ËÆæÁΩÆÂ•ΩÂêéÔºåÂè™Ë¶ÅÊé•Êî∂ÊñπÁöÑemoji‰∏é‰∏ãÊñπÁöÑemojiÁõ∏Á¨¶Âç≥‰∏∫ÂØÜÈí•Ê≠£Á°ÆÔºÅ", hashHintRecv: "Âè™Ë¶ÅËæìÂÖ•ÁöÑAES-256ÂØÜÈí•‰∏ÄËá¥ÔºåemojiÂ∞±‰ºö‰∏ÄËá¥ÔºÅ",
            aiNote: "(‰ª•‰∏ãÊòØ‰Ω†Â∑≤ÈÄâ‰∏≠ÁöÑÊñá‰ª∂Á±ªÂûã)", privWarn: "‚ö†Ô∏è ÈöêÁßÅÊèêÈÜíÔºöÊñá‰ª∂ÂêçÂåÖÂê´ÊïèÊÑü‰ø°ÊÅØ„ÄÇÂº∫ÁÉàÂª∫ËÆÆÂºÄÂêØ AES-256 Âä†ÂØÜÔºÅ",
            ocrDone: "‚úÖ ÊèêÂèñÊàêÂäü!", ocrAdTitle: "Ê≠£Âú®Êú¨Âú∞ËØÜÂà´ÊñáÂ≠óÔºåËØ∑Á®çÁ≠â...", ocrScanTip: "Êà™Â±è / Á≤òË¥¥", ocrUploadTip: "‰∏ä‰º†ÂõæÁâá",
            textPrivWarn: "üõ°Ô∏è ÂÆâÂÖ®Ë≠¶ÂëäÔºöÊ£ÄÊµãÂà∞Áñë‰ººÂØÜÁ†Å„ÄÅÁßÅÈí•„ÄÅÊä§ÁÖßÊàñÈì∂Ë°åÂç°Âè∑„ÄÇÂº∫ÁÉàÂª∫ËÆÆÂºÄÂêØ AES-256 Âä†ÂØÜÔºÅ",
            step1: "ÈÄâÊñá‰ª∂<br><span style='font-size:9px; opacity:0.7'>(ÂèØËæìÊñáÂ≠ó)</span>", step2: "ËÆæÂØÜÁ†Å<br><span style='font-size:9px; opacity:0.7'>(ÂèØÈÄâÂä†ÂØÜ)</span>", step3: "Âèñ‰ª∂Á†Å", step4: "‰∏ãËΩΩ", 
            heroTitle: "FlashDrop ‚Äî ÂÆâÂÖ®ÁöÑ P2P Êñá‰ª∂‰º†Ëæì", heroSub: "Êó†ÊúçÂä°Âô®Â≠òÂÇ®„ÄÇÁ´ØÂà∞Á´ØÂä†ÂØÜ„ÄÇÊñá‰ª∂Ê∞∏‰∏ç‰∏ä‰∫ë„ÄÇ<br>ÊîØÊåÅ AES-256 Âä†ÂØÜ‰øùÊä§‰∏éËá™ÊØÅÊú∫Âà∂„ÄÇ",
            sig1: "Êó†ÈôêÂà∂", sig2: "‰ªÖP2P", sig3: "Ëá™Âä®ÈîÄÊØÅ", modalTitle: "ËÆæÁΩÆÂØÜÁ†Å", btnEnable: "ÂêØÁî®‰øùÊä§", btnCancel: "ÂèñÊ∂à", aesOff: "AES-256 ÂÖ≥Èó≠", aesOn: "AES-256 ÂºÄÂêØ", btnRuthless: "Áã†ÂøÉÊãíÁªùÔºà‰ªÖËøôÊ¨°Ôºâ", strengthLevels: ["ÊûÅÂº±", "Âº±", "‰∏≠Á≠â", "Á®çÂº∫", "Âº∫", "ÊûÅÂº∫", "ÁâπÂà´Âº∫"], faqTitle: "Â∏∏ËßÅÈóÆÈ¢ò", aiInsight: "‚ú® AI Êô∫ËÉΩÂàÜÊûê", aiLocal: "Êú¨Âú∞Â§ÑÁêÜ", aiTags: { img: "üñºÔ∏è ÂõæÂÉè", vid: "üé¨ ËßÜÈ¢ë", doc: "üìÑ ÊñáÊ°£", code: "üíª ‰ª£Á†Å", zip: "üì¶ ÂéãÁº©ÂåÖ", big: "üêò Â§ßÊñá‰ª∂" },
            faqQ1: "Êñá‰ª∂‰ºöÁªèËøá‰Ω†‰ª¨ÁöÑÊúçÂä°Âô®ÂêóÔºü", faqA1: "‰∏ç‰ºö„ÄÇFlashDrop Pro ÈááÁî® WebRTC Êó†ÊúçÂä°Âô® P2P Êû∂ÊûÑ„ÄÇÊï∞ÊçÆÁõ¥Ëøû‰º†Ëæì„ÄÇ", faqQ2: "‰Ω†‰ª¨‰ºö‰øùÁïôÊó•ÂøóÂêóÔºü", faqA2: "Áªù‰∏ç„ÄÇÊàë‰ª¨Èõ∂Áü•ËØÜËøêËê•Ôºå‰∏çÂ≠ò IP ÊàñÊó•Âøó„ÄÇ", faqQ3: "‰ΩøÁî®‰ªÄ‰πàÂä†ÂØÜÔºü", faqA3: "WebRTC Âº∫Âà∂ DTLS/SRTP„ÄÇÂØÜÁ†Å‰øùÊä§Â¢ûÂä† AES-256-GCM„ÄÇ", faqQ4: "ÂØπÊñπËÉΩÁúãÂà∞ÊàëIPÂêóÔºü", faqA4: "P2P ÈúÄË¶Å IP Áõ¥Ëøû„ÄÇ‰ªãÊÑèËØ∑Áî® VPN„ÄÇ", faqQ5: "‰º†Êú∫ÂØÜÊñá‰ª∂ÂÆâÂÖ®ÂêóÔºü", faqA5: "ÂÆâÂÖ®„ÄÇÊï∞ÊçÆ‰∏çÁªèËøáÁ¨¨‰∏âÊñπÊúçÂä°Âô®„ÄÇ", faqQ6: "ÂÖ≥ÊéâÈ°µÈù¢ËÉΩÊÅ¢Â§çÂêóÔºü", faqA6: "‰∏çËÉΩ„ÄÇÊï∞ÊçÆÂè™Âú®ÂÜÖÂ≠òÈáåÔºåÂÖ≥ÊéâÂç≥ÁÑö„ÄÇ", faqQ7: "ÂëòÂ∑•ËÉΩÁúãÊñá‰ª∂ÂêóÔºü", faqA7: "‰∏çËÉΩ„ÄÇÊàë‰ª¨Ê≤°ÂØÜÈí•‰πüÊ≤°Â≠òÂÇ®„ÄÇ", faqQ8: "ÂøÖÈ°ªËÆæÂØÜÁ†ÅÂêóÔºü", faqA8: "ÂèØÈÄâ„ÄÇ‰ΩÜÂª∫ËÆÆÂ±ÄÂüüÁΩëÂÜÖ‰ΩøÁî®Êó∂ËÆæÁΩÆ„ÄÇ", faqQ9: "ËÉΩÈáçÁΩÆÂØÜÁ†ÅÂêóÔºü", faqA9: "‰∏çËÉΩ„ÄÇÂøò‰∫ÜÂ∞±ÁúüÊ≤°‰∫Ü„ÄÇ"
        }
    };

    let currLang = "en", peer = null, stagedFiles = [], currentDownloads = 0, videoTrack = null, torchOn = false, activeConn = null, expiryTimerIdx = null;
    let isAdBlockIgnored = false; 
    let downloadDotsIdx = null; 
    const PREFIX = "fd-pro-";
    const CHUNK_SIZE = 64 * 1024; 

    /* --- [2. ‰øÆÂ§çÂêéÁöÑ applyI18N ÂáΩÊï∞] --- */
    function applyI18N() {
        const userLang = navigator.language.split('-')[0];
        currLang = I18N[userLang] ? userLang : "en";
        const d = I18N[currLang] || I18N.en;

        // Âü∫Á°ÄÊñáÊú¨Êò†Â∞Ñ
        const idMap = {
            'currentLangTag': d.tag, 'hero-title': d.heroTitle, 'hero-subtitle': d.heroSub,
            'drop-text': d.drop, 'label-files': d.fileLab, 
            'btn-share-files': d.shareF, 'btn-share-text': d.shareT, 'btn-connect': d.connect,
            'btn-copy-link': d.copyLink, 'btn-stop': d.stop, 'guideText': d.guide, 
            'foot-coffee': d.coffee, 'link-priv': d.hPriv, 'link-site': d.hSite, 'link-us': d.hUs,
            'btn-scan': d.orScan, 'history-title-text': d.histTitle,
            'sec-fp-title': d.secFpTitle, 'sec-fp-desc': d.secFpDesc,
            'sec-ai-title': d.secAiTitle, 'sec-ai-list': d.secAiList, 
            'sec-burn-title': d.secBurnTitle, 'sec-burn-desc': d.secBurnDesc,
            'sec-access-title': d.secAccessTitle, 'sec-access-desc': d.secAccessDesc,
            'ad-wait-title': d.adWait, 'modal-pass-title': d.modalTitle,
            'btn-enable-pass': d.btnEnable, 'btn-cancel-pass': d.btnCancel,
            'aes-off-txt': d.aesOff, 'aes-on-txt': d.aesOn, 'btn-ruthless-text': d.btnRuthless,
            'faq-title': d.faqTitle, 'pass-input-title': d.passTitle, 
            'btn-pass-confirm': d.passUnlock, 'btn-pass-cancel': d.passCancel,
            'ai-insight-note': d.aiNote, 'signal-1': d.sig1, 'signal-2': d.sig2, 'signal-3': d.sig3,
            'step-1': d.step1, 'step-2': d.step2, 'step-3': d.step3, 'step-4': d.step4
        };

        for (const [id, txt] of Object.entries(idMap)) {
            const el = document.getElementById(id);
            if(el) {
                // ÂàóË°®ÂíåÂâØÊ†áÈ¢ò‰ΩøÁî® innerHTML ‰ª•ÊîØÊåÅ HTML Ê†áÁ≠æ
                if (['hero-subtitle', 'step-1', 'step-2', 'sec-ai-list'].includes(id)) {
                    el.innerHTML = txt;
                } else {
                    el.innerText = txt;
                }
            }
        }

        // ÁâπÊÆäÂ±ûÊÄßËÆæÁΩÆ
        document.getElementById('tip-scan').setAttribute('data-tip', d.ocrScanTip);
        document.getElementById('tip-upload').setAttribute('data-tip', d.ocrUploadTip);
        document.getElementById('alert-password-input').placeholder = d.passPlaceholder;
        document.getElementById('crypto-password').placeholder = d.passPlaceholder;
        document.getElementById('send-hash-hint').innerText = d.hashHintSend || "";
        document.getElementById('recv-hash-hint').innerText = d.hashHintRecv || "";

        // ‚òÖ‚òÖ‚òÖ ‰øÆÂ§çÁÇπÔºöFAQ Âæ™ÁéØÂ°´ÂÖÖ ‚òÖ‚òÖ‚òÖ
        for(let i=1; i<=9; i++) {
            const q = document.getElementById(`faq-q${i}`);
            const a = document.getElementById(`faq-a${i}`);
            if(q && d[`faqQ${i}`]) q.innerText = d[`faqQ${i}`];
            if(a && d[`faqA${i}`]) a.innerText = d[`faqA${i}`];
        }
        
        updateNetworkStatus();
    }

    function updateNetworkStatus() {
        const isOnline = navigator.onLine; 
        const dot = document.getElementById('status-dot'); 
        const text = document.getElementById('status-text');
        const d = I18N[currLang] || I18N.en;
        if (isOnline) { 
            dot.className = 'status-dot online'; 
            text.className = 'status-text online'; 
            text.innerText = d.on; 
        } else { 
            dot.className = 'status-dot offline'; 
            text.className = 'status-text offline'; 
            text.innerText = d.off; 
        }
    }
    window.addEventListener('online', updateNetworkStatus);
    window.addEventListener('offline', updateNetworkStatus);

    /* --- [AI & OCR ÈÄªËæë] --- */
    const AIEngine = {
        analyze(files) {
            const tags = new Set(); let risk = false;
            if (!files || files.length === 0) return { tags: [], risk: false };
            const exts = { img: ['jpg','png','webp','jpeg'], vid: ['mp4','mov','avi'], doc: ['pdf','docx','txt','xlsx'], code: ['js','py','html','css'], zip: ['zip','rar','7z'] };
            const sensitive = ['id', 'passport', 'secret', 'key', 'Ë∫´‰ªΩËØÅ', 'Êä§ÁÖß', 'ÁßÅÈí•', 'ÂØÜÁ†Å', 'ssn'];
            Array.from(files).forEach(f => {
                const ext = f.name.split('.').pop().toLowerCase();
                for(let k in exts) if(exts[k].includes(ext)) tags.add(k);
                if(f.size > 100*1024*1024) tags.add('big');
                if(!risk) sensitive.forEach(s => { if(f.name.toLowerCase().includes(s)) risk = true; });
            });
            return { tags: Array.from(tags), risk: risk };
        },
        renderTags(data) {
            const c = document.getElementById('ai-tag-container');
            const alert = document.getElementById('ai-privacy-alert');
            const wrap = document.getElementById('ai-suggestions');
            if(!data.tags.length) { wrap.style.display='none'; alert.style.display='none'; return; }
            wrap.style.display='block';
            alert.style.display = data.risk ? 'block' : 'none';
            if(data.risk) alert.innerText = (I18N[currLang]||I18N.en).privWarn;
            const dict = (I18N[currLang]||I18N.en).aiTags;
            c.innerHTML = data.tags.map(t => `<span class="ai-smart-tag">${dict[t]||t}</span>`).join('');
        }
    };

    function checkTextPrivacy(text) {
        const wrap = document.getElementById('text-ai-suggestions');
        const alert = document.getElementById('text-privacy-alert');
        if(!text.trim()) { wrap.style.display='none'; return; }
        const risks = ["password", "key", "secret", "card", "Ë∫´‰ªΩËØÅ", "ÂØÜÁ†Å", "ÁßÅÈí•", "Èì∂Ë°åÂç°"];
        const hasRisk = risks.some(r => text.toLowerCase().includes(r)) || /\b\d{16}\b/.test(text);
        if(hasRisk) {
            wrap.style.display='block'; alert.style.display='block';
            alert.innerText = (I18N[currLang]||I18N.en).textPrivWarn;
        } else { wrap.style.display='none'; }
    }

    function runOCRWithAd(blob) {
        if(detectAdBlock()) return;
        const modal = document.getElementById('ocrAdModal');
        const bar = document.getElementById('ocr-pg-bar');
        const txt = document.getElementById('ocr-timer-text');
        const title = document.getElementById('ocr-ad-title');
        title.innerText = (I18N[currLang]||I18N.en).adWait;
        
        modal.style.display = 'flex'; bar.style.width = '0%';
        let t = 0; const dur = 5000;
        const itv = setInterval(() => {
            t += 100; bar.style.width = (t/dur)*100+'%';
            txt.innerText = `Remaining: ${Math.ceil((dur-t)/1000)}s`;
            if(t >= dur) {
                clearInterval(itv); modal.style.display='none';
                document.getElementById('ocrLoadingModal').style.display='flex';
                setTimeout(() => performOCR(blob), 100);
            }
        }, 100);
    }

    async function performOCR(blob) {
        try {
            const { data: { text } } = await Tesseract.recognize(blob, 'eng+chi_sim', { logger: m => document.getElementById('ocr-loading-text').innerText=`Reading... ${Math.floor(m.progress*100)}%` });
            const box = document.getElementById('quickText');
            box.value += (box.value ? "\n" : "") + text.trim();
            updateTextCount(box); checkTextPrivacy(box.value);
            showCustomAlert((I18N[currLang]||I18N.en).ocrDone);
        } catch(e) { showCustomAlert("OCR Failed: " + e.message); }
        finally { document.getElementById('ocrLoadingModal').style.display='none'; }
    }

    function triggerOCRAd(mode) {
        if(mode==='upload') document.getElementById('ocrInput').click();
        else if(mode==='scan') handleOCRPaste();
    }
    
    function handleOCRPaste() {
        navigator.mediaDevices.getDisplayMedia({video:true}).then(stream => {
            const track = stream.getVideoTracks()[0];
            new ImageCapture(track).grabFrame().then(bmp => {
                track.stop();
                const cvs = document.createElement('canvas'); 
                cvs.width=bmp.width; cvs.height=bmp.height;
                cvs.getContext('2d').drawImage(bmp,0,0);
                cvs.toBlob(runOCRWithAd);
            });
        }).catch(() => {});
    }

    /* --- [Core P2P & Crypto] --- */
    let isEncrypted = false, aesKey = "";
    const FlashDropCrypto = {
        async derive(p, s) { const k = await crypto.subtle.importKey("raw", new TextEncoder().encode(p), "PBKDF2", false, ["deriveKey"]); return crypto.subtle.deriveKey({ name: "PBKDF2", salt: s, iterations: 600000, hash: "SHA-256"}, k, { name: "AES-GCM", length: 256 }, false, ["encrypt", "decrypt"]); },
        async encrypt(blob, p) { const s = crypto.getRandomValues(new Uint8Array(16)); const iv = crypto.getRandomValues(new Uint8Array(12)); const k = await this.derive(p, s); const buf = await blob.arrayBuffer(); const ct = await crypto.subtle.encrypt({ name: "AES-GCM", iv: iv }, k, buf); return new Blob([s, iv, new Uint8Array(ct)]); },
        async decrypt(blob, p) { const buf = await blob.arrayBuffer(); const s = new Uint8Array(buf.slice(0,16)); const iv = new Uint8Array(buf.slice(16,28)); const ct = buf.slice(28); const k = await this.derive(p, s); const pt = await crypto.subtle.decrypt({ name: "AES-GCM", iv: iv }, k, ct); return new Blob([pt]); }
    };

    function confirmEncryption() {
        const p = document.getElementById('crypto-password').value;
        const hasUpper = /[A-Z]/.test(p); const hasLower = /[a-z]/.test(p); const hasNum = /[0-9]/.test(p);
        if(p.length < 8 || !hasUpper || !hasLower || !hasNum) { showCustomAlert((I18N[currLang]||I18N.en).passWeak); return; }
        aesKey = p; isEncrypted = true;
        document.getElementById('protection-toggle-input').checked = true;
        document.getElementById('crypto-modal').style.display='none';
    }
    
    function showCryptoModal() {
        if(isEncrypted) { isEncrypted=false; aesKey=""; document.getElementById('protection-toggle-input').checked=false; document.getElementById('crypto-password').value=""; checkStrength(""); return; }
        document.getElementById('crypto-modal').style.display='flex';
    }

    function checkStrength(p) { 
        const bar = document.getElementById('strength-bar-fill'); 
        const txt = document.getElementById('strength-text'); 
        let score = 0; if(!p) { bar.style.width='0%'; bar.style.backgroundColor='#ef4444'; txt.innerText='Empty'; return; }
        score += p.length * 3; if(/[A-Z]/.test(p)) score+=10; if(/[a-z]/.test(p)) score+=10; if(/[0-9]/.test(p)) score+=10; if(/[^A-Za-z0-9]/.test(p)) score+=10;
        if(score>100) score=100; const hue=Math.floor((score/100)*120); 
        bar.style.width=`${score}%`; bar.style.backgroundColor=`hsl(${hue}, 90%, 45%)`;
        const levels = (I18N[currLang]||I18N.en).strengthLevels;
        let idx = Math.floor(score/14.5); if(idx>=levels.length) idx=levels.length-1;
        txt.innerText = levels[idx]; txt.style.color=`hsl(${hue}, 80%, 40%)`;
    }

    function togglePwd(id, btn) { const el = document.getElementById(id); if(el.type==='password'){ el.type='text'; btn.innerText='üôâ'; } else { el.type='password'; btn.innerText='üôà'; } }
    async function updateFingerprint(val, elId, hintId) {
        const el = document.getElementById(elId); const hint = document.getElementById(hintId);
        if (!val) { el.style.display='none'; if(hint) hint.style.display='none'; return; }
        el.style.display='block'; if(hint) hint.style.display='block';
        const msgBuffer = new TextEncoder().encode(val);
        const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
        const hashArray = Array.from(new Uint8Array(hashBuffer));
        const emojis = ["‚ö°","üõ°Ô∏è","üöÄ","ü§ñ","üíé","üî•","üåü","üåä","üêØ","üêµ","üçé","üçÄ","üé≤","üß©","üîÆ","üéµ","üé©","üëª","üåµ","üçï","üåô","‚òÄÔ∏è","üåà","‚ùÑÔ∏è"];
        let res = ""; for(let i=0; i<4; i++) res += emojis[hashArray[i] % emojis.length];
        el.innerText = res;
    }

    /* --- [Main Logic] --- */
    function triggerAd(mode) {
        if(mode==='receive' && document.getElementById('targetCode').value.length<6) { showCustomAlert((I18N[currLang]||I18N.en).inputErr); return; }
        if(mode==='send-file' && !stagedFiles.length) { showCustomAlert((I18N[currLang]||I18N.en).fileErr); return; }
        if(mode==='send-text' && !document.getElementById('quickText').value.trim()) { showCustomAlert((I18N[currLang]||I18N.en).textErr); return; }
        if(isAdBlockIgnored) { mode.startsWith('send')?initSender():startReceiving(); return; }
        if(detectAdBlock()) return;

        const modal = document.getElementById('adModal');
        const bar = document.getElementById('ad-pg-bar');
        const txt = document.getElementById('ad-timer-text');
        const title = document.getElementById('ad-wait-title');
        title.innerText = (I18N[currLang]||I18N.en).adWait;

        modal.style.display='flex'; bar.style.width='0%';
        let t=0; const dur=5000;
        const itv = setInterval(() => {
            t+=100; bar.style.width=(t/dur)*100+'%';
            txt.innerText=`Remaining: ${Math.ceil((dur-t)/1000)}s`;
            if(t>=dur) {
                clearInterval(itv); modal.style.display='none';
                mode.startsWith('send')?initSender():startReceiving();
            }
        }, 100);
    }

    function initSender() {
        if(peer) peer.destroy();
        const code = Math.floor(100000 + Math.random() * 900000);
        peer = new Peer(PREFIX + code);
        peer.on('open', () => {
            document.getElementById('senderCodeArea').style.display='block';
            document.getElementById('senderCodeArea').scrollIntoView({ behavior: 'smooth', block: 'center' });
            document.getElementById('myCode').innerText = code;
            document.getElementById('qrcode').innerHTML = "";
            new QRCode(document.getElementById('qrcode'), { text: window.location.href.split('?')[0] + "?c=" + code, width: 140, height: 140 });
            document.getElementById('btn-copy-link').onclick = () => { navigator.clipboard.writeText(window.location.href.split('?')[0]+"?c="+code); showCustomAlert("Link Copied!"); };
            startExpiryTimer();
        });
        peer.on('connection', c => {
            c.on('data', d => {
                if (d.type === 'security_burn') { showCustomAlert("‚ö†Ô∏è SECURITY ALERT: Connection burned."); resetSender(); return; }
                if(d.type==='confirm_save') { currentDownloads++; if(currentDownloads >= document.getElementById('downloadLimit').value) resetSender(); }
            });
            c.on('open', async () => {
                const txt = document.getElementById('quickText').value.trim();
                if(txt) {
                    if(isEncrypted) {
                        const enc = await FlashDropCrypto.encrypt(new Blob([txt]), aesKey);
                        const r = new FileReader(); r.onload=()=>c.send({type:'text', data:r.result, encrypted:true}); r.readAsDataURL(enc);
                    } else c.send({type:'text', data:txt, encrypted:false});
                    addHistory("Sent Text", "text");
                }
                if(stagedFiles.length) {
                    let b; const n = stagedFiles.length===1 ? stagedFiles[0].name : "Bundle.zip";
                    if(stagedFiles.length===1) b = stagedFiles[0];
                    else { const z = new JSZip(); stagedFiles.forEach(f=>z.file(f.name,f)); b = await z.generateAsync({type:"blob"}); }
                    if(isEncrypted) { b = await FlashDropCrypto.encrypt(b, aesKey); }
                    c.send({type:'meta', name:n+(isEncrypted?".enc":""), size:b.size, encrypted:isEncrypted});
                    const buf = await b.arrayBuffer();
                    for(let i=0; i<b.size; i+=CHUNK_SIZE) {
                        while(c.bufferSize > 1024*1024) await new Promise(r=>setTimeout(r,50));
                        c.send({type:'chunk', data:buf.slice(i, i+CHUNK_SIZE)});
                    }
                    c.send({type:'done'});
                    addHistory("Sent: " + n, "file");
                }
            });
        });
    }

    function startReceiving() {
        const code = document.getElementById('targetCode').value;
        const rPeer = new Peer();
        const btn = document.getElementById('btn-connect');
        btn.disabled=true; btn.innerText="Connecting...";
        
        rPeer.on('open', () => {
            const conn = rPeer.connect(PREFIX + code, {reliable:true});
            activeConn = conn;
            let meta=null, chunks=[], rec=0;
            conn.on('data', async d => {
                if(d.type==='text') {
                    btn.innerText = d.encrypted ? (I18N[currLang]||I18N.en).decryptRecv : (I18N[currLang]||I18N.en).recv;
                    btn.disabled=false; btn.style.background=d.encrypted?"#f59e0b":"#10b981"; btn.style.opacity="1";
                    btn.onclick = async () => {
                        let txt = d.data;
                        if(d.encrypted) {
                            let attempts = 0;
                            while(true) {
                                const p = await requestPassword(attempts > 0 ? 3-attempts : undefined); if(!p) return;
                                try {
                                    const b = await (await fetch(txt)).blob();
                                    txt = await (await FlashDropCrypto.decrypt(b, p)).text();
                                    break; 
                                } catch { attempts++; if(attempts>=3) { conn.send({type:'security_burn'}); showCustomAlert("Data Wiped."); resetReceiver(); return; } }
                            }
                        }
                        document.getElementById('receivedText').innerText = txt;
                        document.getElementById('receivedText-container').style.display='block';
                        conn.send({type:'confirm_save'});
                        addHistory("Recv Text", "text");
                    };
                } else if(d.type==='meta') {
                    meta=d; document.getElementById('receive-pg-container').style.display='block';
                    document.getElementById('receiveNerdStats').style.display='flex';
                } else if(d.type==='chunk') {
                    chunks.push(d.data); rec+=d.data.byteLength;
                    document.getElementById('receive-pg-bar').style.width = (rec/meta.size*100)+'%';
                } else if(d.type==='done') {
                    btn.innerText = meta.encrypted ? (I18N[currLang]||I18N.en).decryptSave : (I18N[currLang]||I18N.en).save;
                    btn.disabled=false; btn.style.background=meta.encrypted?"#f59e0b":"#10b981"; btn.style.opacity="1";
                    const blob = new Blob(chunks);
                    btn.onclick = async () => {
                        let finalB = blob;
                        if(meta.encrypted) {
                            let attempts = 0;
                            while(true) {
                                const p = await requestPassword(attempts > 0 ? 3-attempts : undefined); if(!p) return;
                                try { finalB = await FlashDropCrypto.decrypt(blob, p); break; }
                                catch { attempts++; if(attempts>=3) { conn.send({type:'security_burn'}); showCustomAlert("Data Wiped."); resetReceiver(); return; } }
                            }
                        }
                        const u = URL.createObjectURL(finalB);
                        const a = document.createElement('a'); a.href=u; a.download=meta.name.replace('.enc',''); a.click();
                        conn.send({type:'confirm_save'});
                        addHistory("Recv: " + meta.name, "file");
                    };
                }
            });
        });
    }

    /* --- [Search Widget Logic] --- */
    const SearchWidget = {
        trending: [
            "How to transfer 10GB file fast?", "Is FlashDrop safer than AirDrop?", "AES-256 encryption details", 
            "Send photos without quality loss", "P2P vs Cloud storage", "Offline file sharing tips",
            "Generate strong passwords", "Prevent Man-in-the-Middle attacks"
        ],
        history: JSON.parse(localStorage.getItem('fd_search_history') || "[]"),
        scope: "Global",
        tickerIdx: 0,
        interval: null,
        
        init() { this.renderTicker(); this.startRotation(); this.renderDropdown(); },
        startRotation() {
            if(this.interval) clearInterval(this.interval);
            this.interval = setInterval(() => { this.tickerIdx = (this.tickerIdx+1)%this.trending.length; this.renderTicker(); }, 4000);
        },
        renderTicker() {
            const el = document.getElementById('searchTickerText');
            el.style.animation='none'; el.offsetHeight; el.style.animation='slideUp 0.5s ease-out';
            el.innerText = "üî• " + this.trending[this.tickerIdx];
        },
        toggleDropdown() {
            const dd = document.getElementById('searchDropdown');
            const wrap = document.getElementById('searchWidget');
            if (dd.style.display==='flex') { dd.style.display='none'; wrap.classList.remove('active'); this.startRotation(); } 
            else { dd.style.display='flex'; wrap.classList.add('active'); clearInterval(this.interval); document.getElementById('searchTickerText').innerText = "üîç Search: " + this.trending[this.tickerIdx]; }
        },
        selectItem(text) { showCustomAlert("Searching for: " + text); this.addToHistory(text); this.toggleDropdown(); },
        addToHistory(text) {
            this.history = this.history.filter(i=>i!==text); this.history.unshift(text);
            if(this.history.length>5) this.history.pop();
            localStorage.setItem('fd_search_history', JSON.stringify(this.history));
            this.renderDropdown();
        },
        renderDropdown() {
            const tList = document.getElementById('trendingList');
            const hList = document.getElementById('searchHistoryTags');
            tList.innerHTML = this.trending.slice(0,5).map((t,i)=>`<div class="sd-item" onclick="SearchWidget.selectItem('${t}')"><span class="sd-rank rank-${i+1}">${i+1}</span><span>${t}</span></div>`).join('');
            hList.innerHTML = this.history.length ? this.history.map(h=>`<span class="history-tag" onclick="SearchWidget.selectItem('${h}')">${h}</span>`).join('') : '<span style="font-size:11px;color:#64748b;">No recent history</span>';
        },
        cycleScope() { const s = ["Global", "Local", "Friends", "Saved"]; this.scope = s[(s.indexOf(this.scope)+1)%s.length]; document.getElementById('searchScope').innerText = this.scope; }
    };
    function toggleSearchDropdown() { SearchWidget.toggleDropdown(); }
    function cycleSearchScope() { SearchWidget.cycleScope(); }

    /* --- [Helpers & Init] --- */
    function requestPassword(attempts) {
        return new Promise(r => {
            const m = document.getElementById('pass-input-modal');
            const i = document.getElementById('alert-password-input');
            const err = document.getElementById('pass-error-msg');
            m.style.display='flex'; i.value=""; i.focus();
            if(attempts) err.innerText = `Wrong password! ${attempts} attempts left.`; else err.innerText="";
            document.getElementById('btn-pass-confirm').onclick = () => { m.style.display='none'; r(i.value); };
            document.getElementById('btn-pass-cancel').onclick = () => { m.style.display='none'; r(null); };
        });
    }
    function handleFiles(files) { stagedFiles = Array.from(files); renderStagedList(); }
    function renderStagedList() {
        const l = document.getElementById('stagedList');
        if(!stagedFiles.length) { l.style.display='none'; document.getElementById('file-count-badge').style.display='none'; AIEngine.renderTags({tags:[],risk:false}); return; }
        l.style.display='block'; document.getElementById('file-count-badge').style.display='block'; document.getElementById('file-count-badge').innerText=`${stagedFiles.length} Files`;
        l.innerHTML = stagedFiles.map((f,i)=>`<div class="staged-item"><span>${f.name}</span><span style="color:var(--danger);cursor:pointer;" onclick="stagedFiles.splice(${i},1);renderStagedList()">‚úï</span></div>`).join('');
        AIEngine.renderTags(AIEngine.analyze(stagedFiles));
    }
    function updateTextCount(el) { const b=document.getElementById('text-count-badge'); b.style.display=el.value.length?'block':'none'; b.innerText=el.value.length+" Chars"; }
    function detectAdBlock() {
        if(isAdBlockIgnored) return false;
        const ad = document.getElementById('top-ad-zone');
        if(ad.offsetHeight < 10) { document.getElementById('safety-notice-view').style.display='flex'; return true; }
        return false;
    }
    function startExpiryTimer() {
        let s = 600;
        expiryTimerIdx = setInterval(() => {
            s--; document.getElementById('expiryTimer').innerText = `Expires: ${Math.floor(s/60)}:${(s%60).toString().padStart(2,'0')}`;
            if(s<=0) resetSender();
        }, 1000);
    }
    function resetSender() {
        if(peer) peer.destroy(); document.getElementById('senderCodeArea').style.display='none';
        stagedFiles=[]; renderStagedList(); document.getElementById('quickText').value="";
        clearInterval(expiryTimerIdx);
    }
    function resetReceiver() {
        document.getElementById('targetCode').value=""; document.getElementById('receive-pg-container').style.display='none';
        document.getElementById('receiveNerdStats').style.display='none'; document.getElementById('receivedText-container').style.display='none';
        const btn=document.getElementById('btn-connect'); btn.disabled=false; btn.innerText=(I18N[currLang]||I18N.en).connect; btn.style.background="var(--primary)";
    }
    function showCustomAlert(msg) { document.getElementById('alert-msg').innerText = msg; document.getElementById('alert-modal').style.display = 'flex'; }
    function closePolicy() { document.getElementById('policyModal').style.display='none'; }
    function closeScanner() { document.getElementById('scanner-modal').style.display='none'; if(videoTrack) videoTrack.stop(); }
    function dismissAdBlock() { isAdBlockIgnored=true; document.getElementById('safety-notice-view').style.display='none'; document.querySelectorAll('.ad-space, .ad-side').forEach(e=>e.style.display='none'); }
    function addHistory(n,t) { 
        let h = JSON.parse(localStorage.getItem('fd_history')||"[]"); h.unshift({name:n, time:new Date().toLocaleTimeString(), type:t}); 
        h=h.slice(0,5); localStorage.setItem('fd_history', JSON.stringify(h)); renderHistory(); 
    }
    function renderHistory() {
        const l = document.getElementById('history-list');
        const h = JSON.parse(localStorage.getItem('fd_history')||"[]");
        l.innerHTML = h.map(i=>`<div class="history-item"><span>${i.type==='file'?'üìÑ':'üî§'} ${i.name}</span><span style="opacity:0.5">${i.time}</span></div>`).join('');
    }
    function copyReceivedText() { navigator.clipboard.writeText(document.getElementById('receivedText').innerText); showCustomAlert("Copied!"); }
    
    window.onload = () => {
        applyI18N();
        SearchWidget.init();
        const c = document.getElementById('stars');
        for(let i=0; i<60; i++) {
            const s = document.createElement('div'); s.className='star'; s.style.left=Math.random()*100+'%'; s.style.top=Math.random()*100+'%'; s.style.animationDuration=(Math.random()*20+10)+'s'; c.appendChild(s);
        }
        const dz = document.getElementById('drop-zone');
        document.body.addEventListener('dragenter', e => { if(e.dataTransfer.types.includes('Files')) dz.style.display='flex'; });
        dz.addEventListener('drop', e => { e.preventDefault(); dz.style.display='none'; handleFiles(e.dataTransfer.files); switchTab('send'); });
        dz.addEventListener('dragleave', e => { if(e.target===dz) dz.style.display='none'; });
        window.addEventListener('dragover', e => e.preventDefault());
        renderHistory();
        setTimeout(detectAdBlock, 2000);
    };
    function switchTab(t, e) {
        document.querySelectorAll('.tab').forEach(e=>e.classList.remove('active'));
        document.querySelectorAll('.panel').forEach(e=>e.classList.remove('active'));
        document.getElementById('tab-'+t).classList.add('active');
        document.getElementById('panel-'+t).classList.add('active');
        if(e) e.target.classList.add('active'); else document.getElementById('tab-'+t).classList.add('active');
    }
    async function toggleTorch() { if(videoTrack) { torchOn=!torchOn; await videoTrack.applyConstraints({advanced:[{torch:torchOn}]}); } }
    async function openScanner() {
        document.getElementById('scanner-modal').style.display='flex';
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
            const v = document.getElementById('video-preview'); v.srcObject = stream; videoTrack = stream.getVideoTracks()[0]; v.play();
            requestAnimationFrame(tickScanner);
        } catch { showCustomAlert("Camera Error"); closeScanner(); }
    }
    function tickScanner() {
        const v = document.getElementById('video-preview');
        if(v.readyState===v.HAVE_ENOUGH_DATA) {
            const cvs=document.createElement("canvas"); cvs.width=v.videoWidth; cvs.height=v.videoHeight;
            const ctx=cvs.getContext("2d"); ctx.drawImage(v,0,0);
            const d = jsQR(ctx.getImageData(0,0,cvs.width,cvs.height).data, cvs.width, cvs.height);
            if(d && d.data.includes('?c=')) { document.getElementById('targetCode').value = new URL(d.data).searchParams.get("c"); closeScanner(); triggerAd('receive'); return; }
        }
        if(document.getElementById('scanner-modal').style.display==='flex') requestAnimationFrame(tickScanner);
    }
</script>
</body>
</html>
